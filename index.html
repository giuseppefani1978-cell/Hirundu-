<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Le Vol d‚ÄôAracne ‚Äî Salento (Chasse au tr√©sor)</title>
<style>
  #debugBox { pointer-events: none; }  
  /* ====== Base & Canvas ====== */
  html,body{height:100%;margin:0;background:#a9d6f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{-webkit-tap-highlight-color:transparent}
  .wrap{display:flex;flex-direction:column;height:100%}
  .game{position:relative;flex:1;overflow:hidden}
  canvas{width:100%;height:100%;display:block;background:#bfe2f8;touch-action:none}

  /* ====== Overlay (Start) ====== */
  .overlay{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(169,214,245,.84);backdrop-filter:blur(3px);z-index:50
  }
  .card{
    width:min(560px,92vw);border:2px solid #c8b37a;border-radius:14px;background:#fffdf5;
    box-shadow:0 10px 26px rgba(0,0,0,.18);padding:18px;text-align:center
  }
  .card h1{margin:0 0 6px 0;font-size:24px}
  .card p{margin:6px 0 14px 0;opacity:.82}
  .card button{border:1px solid #c8b37a;background:#ffe8a6;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
  /* Intro anim ‚Äî small CSS-only cinematic */
  .heroes{display:flex;justify-content:center;gap:16px;margin:10px 0 8px 0;position:relative}
  .heroes img{
    width:72px;height:72px;object-fit:contain;image-rendering:pixelated;image-rendering:crisp-edges;
    animation:floatY 2.4s ease-in-out infinite, pulse 3.2s ease-in-out infinite;
    filter: drop-shadow(0 3px 6px rgba(0,0,0,.25));
  }
  .heroes img#heroAr{animation-delay:.0s,.0s}
  .heroes img#heroTa{animation-delay:.6s,.3s}
  @keyframes floatY{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

  .inspiration{font-size:.92em;font-style:italic;color:#555;margin:2px 0 16px}

  /* ====== HUD ‚Äî √©troit (‚âà moiti√©) ====== */
  .hud{
    position:absolute;left:8px;top:50%;transform:translateY(-50%);
    background:rgba(255,248,220,.96);border:2px solid #c8b37a;border-radius:10px;
    padding:8px 6px;font-size:14px;z-index:22;width:42px;
    display:flex;flex-direction:column;align-items:center;gap:6px
  }
  .hud h3{margin:0;font-size:14px;line-height:1;text-align:center}
  .hud .score{margin:0;font-weight:800;font-size:13px;line-height:1.1}
  .stars{display:flex;flex-direction:column;gap:4px;margin-top:2px;align-items:center}
  .star{width:15px;height:15px;opacity:.95}

  /* ====== Bulle Tarantula ‚Äî fix√©e en haut-gauche ====== */
  .tarTop{
    position:absolute;display:none;align-items:flex-start;gap:8px;z-index:40;max-width:calc(100vw - 16px);
    left:8px; top:8px;
  }
  .tarTop.show{display:flex}
  .tarTop img{width:56px;height:56px;object-fit:contain;background:transparent;border:none;border-radius:0;box-shadow:none;image-rendering:pixelated}
  .bdBubble{
    max-width:min(860px,92vw);
    background:#fff;border:1px solid #bbb;border-radius:12px;
    padding:8px 10px;box-shadow:0 4px 10px rgba(0,0,0,.12);
    font-size:14px;line-height:1.35
  }
  .bdTitle{font-weight:700;margin:0 0 4px 0}
  .bdBubble p{margin:0}

  /* ====== D-pad (compact) ====== */
  .touch{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:none;gap:12px;align-items:center;z-index:30}
  .touch.show{display:flex}
  .dpad{display:grid;grid-template-columns:56px 56px 56px;grid-template-rows:56px 56px 56px;gap:10px}
  .btn{width:56px;height:56px;border-radius:12px;border:2px solid #c8b37a;background:#fff7de;
       display:flex;align-items:center;justify-content:center;user-select:none;touch-action:none;font-weight:800;font-size:20px;box-shadow:0 3px 0 #c8b37a}
  .btn:active{transform:translateY(1px)}

  /* ====== Boutons ====== */
  #musicBtn{
    position:absolute;right:10px;bottom:10px;z-index:45;
    background:#ffe8a6;border:2px solid #c8b37a;border-radius:10px;padding:8px 12px;font-weight:700;display:none;cursor:pointer
  }
  #replayFloat{
    position:absolute;left:50%;bottom:14px;transform:translateX(-50%);
    z-index:46;display:none;border:2px solid #7ac37a;background:#eaffea;font-weight:800;border-radius:10px;padding:8px 12px;
    box-shadow:0 6px 14px rgba(0,0,0,.15);cursor:pointer
  }

  /* ====== Erreurs / Debug ====== */
  .err{position:absolute;right:10px;top:10px;background:#ffefef;border:2px solid #d66;border-radius:10px;padding:8px 10px;font-size:12px;color:#900;z-index:60;max-width:min(320px,60vw)}
  .err b{display:block;margin-bottom:4px}
  #debugBox{position:fixed;left:10px;bottom:10px;z-index:9999;background:#ffefef;border:2px solid #d66;
    padding:8px 10px;border-radius:8px;font:12px/1.3 system-ui;max-width:80vw;display:none}
</style>
</head>
<body>
  <!-- ====== BADGE VERSION VISUELLE ====== -->
  <div id="__ver__"
       style="position:fixed;right:8px;bottom:8px;z-index:9999;
              background:rgba(0,0,0,.55);color:#fff;font:12px system-ui;
              padding:4px 6px;border-radius:6px;pointer-events:none">
    v2025-08-20-e ‚Ä¢ host=<span id="__host__"></span>
  </div>

  <div class="wrap">
    <div class="game">
      <!-- ===== Overlay Start (avec mini ‚Äúcin√©matique‚Äù) ===== -->
      <div class="overlay" id="overlay">
        <div class="card" id="overlayCard">
          <div class="heroes">
            <img id="heroAr" alt="Aracne">
            <img id="heroTa" alt="Tarantula">
          </div>
          <h1 id="titleH1">Le Vol d‚ÄôAracne</h1>
          <p id="subtitleP">Collecte les 10 √©toiles et d√©couvre 10 lieux secrets du Salento.</p>
          <p class="inspiration" id="inspiredP">Inspir√© par le fameux roman</p>
          <button id="startBtn" type="button" onclick="window.startGame && window.startGame()">D√©marrer</button>
        </div>
      </div>

      <!-- ===== UI ===== -->
      <button id="musicBtn" type="button">üéµ Musique</button>
      <button id="replayFloat" type="button">‚ü≤ Rejouer</button>
      <div class="err" id="err" style="display:none"><b id="errTitle">‚ö†Ô∏è Probl√®me d‚Äôassets</b><div id="errText"></div></div>
      <canvas id="c"></canvas>

      <!-- HUD colonne gauche (narrow) -->
      <div class="hud" id="hud">
        <h3 id="hudLabel">√âtoiles</h3>
        <div class="score" id="score">0/10</div>
        <div class="stars" id="stars"></div>
      </div>

      <!-- Bulle Tarantula (fix√©e en haut √† gauche) -->
      <div class="tarTop" id="tarTop">
        <img id="tarAvatar" alt="Tarantula">
        <div class="bdBubble">
          <div class="bdTitle" id="bdTitle">Tarantula</div>
          <p id="bdText"></p>
        </div>
      </div>

      <!-- D-pad tactile -->
      <div class="touch" id="touch">
        <div class="dpad">
          <div></div> <div class="btn" data-dx="0" data-dy="-1">‚Üë</div> <div></div>
          <div class="btn" data-dx="-1" data-dy="0">‚Üê</div> <div></div> <div class="btn" data-dx="1" data-dy="0">‚Üí</div>
          <div></div> <div class="btn" data-dx="0" data-dy="1">‚Üì</div> <div></div>
        </div>
      </div>
    </div>
  </div>
  <div id="debugBox"></div>

  <!-- ====== VERSION & CACHE-BUSTER ====== -->
  <script>
    window.APP_VERSION = "v2025-08-20-e";
    window.APP_Q = "?v=" + window.APP_VERSION;
    (function(){ var s=document.getElementById("__host__"); if(s) s.textContent = location.hostname; console.log("[BUILD]", window.APP_VERSION, location.hostname); })();
  </script>

  <!-- ====== NO-SW : purge anciens SW/caches (si jamais) ====== -->
  <script>
    (function(){
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations()
          .then(function(list){
            list.forEach(function(r){ r.unregister(); });
            if (window.caches && caches.keys) {
              caches.keys().then(function(keys){ keys.forEach(function(k){ caches.delete(k); }); });
            }
          })
          .catch(function(){});
      }
    })();
  </script>

  <!-- Bouton Force Refresh (optionnel) -->
  <button id="__force__"
          type="button"
          style="position:fixed;left:8px;bottom:8px;z-index:9999;
                 background:#ffd;text-transform:uppercase;border:1px solid #cc3;
                 border-radius:6px;padding:6px 8px;font:12px system-ui;cursor:pointer">
    Force Refresh
  </button>
  <script>
    (function(){
      var btn = document.getElementById('__force__');
      if (!btn) return;
      btn.addEventListener('click', function(){
        console.log('Force refresh click');
        var url = new URL(location.href);
        url.searchParams.set('t', Date.now());
        location.replace(url.toString());
      });
    })();
  </script>

<script>
/* =========================================================
   I18N ‚Äî dictionnaires + d√©tection robuste
========================================================= */
const I18N = {
  fr: {
    title: "Le Vol d‚ÄôAracne",
    subtitle: "Collecte les 10 √©toiles et d√©couvre 10 lieux secrets du Salento.",
    start: "D√©marrer",
    hudStars: "√âtoiles",
    musicOn: "‚èπÔ∏è Musique",
    musicOff: "üéµ Musique",
    replay: "‚ü≤ Rejouer",
    ask: (info) => `Dis-moi, o√π est ${info} ?`,
    success: (name) => `Bravo, c‚Äôest exactement √ßa : ${name} !`,
    errTitle: "‚ö†Ô∏è Probl√®me d‚Äôassets",
    mapNotLoaded: (url)=>`Carte non charg√©e : ${url}`,
    assetMissing: (who,url)=>`‚Ä¢ ${who} introuvable : "${url}"`
  },
  it: {
    title: "Il Volo di Aracne",
    subtitle: "Raccogli le 10 stelle e scopri 10 luoghi segreti del Salento.",
    start: "Avvia",
    hudStars: "Stelle",
    musicOn: "‚èπÔ∏è Musica",
    musicOff: "üéµ Musica",
    replay: "‚ü≤ Rigioca",
    ask: (info) => `Dimmi, dov‚Äô√® ${info}?`,
    success: (name) => `Bravissimo, √® proprio ${name}!`,
    errTitle: "‚ö†Ô∏è Problema con le risorse",
    mapNotLoaded: (url)=>`Mappa non caricata: ${url}`,
    assetMissing: (who,url)=>`‚Ä¢ ${who} non trovato: "${url}"`
  },
  es: {
    title: "El Vuelo de Aracne",
    subtitle: "Recoge las 10 estrellas y descubre 10 lugares secretos del Salento.",
    start: "Empezar",
    hudStars: "Estrellas",
    musicOn: "‚èπÔ∏è M√∫sica",
    musicOff: "üéµ M√∫sica",
    replay: "‚ü≤ Repetir",
    ask: (info) => `Dime, ¬ød√≥nde est√° ${info}?`,
    success: (name) => `¬°Bien hecho! Es exactamente: ${name}.`,
    errTitle: "‚ö†Ô∏è Problema de recursos",
    mapNotLoaded: (url)=>`Mapa no cargado: ${url}`,
    assetMissing: (who,url)=>`‚Ä¢ ${who} no encontrado: "${url}"`
  },
  en: {
    title: "Aracne‚Äôs Flight",
    subtitle: "Collect 10 stars and discover 10 secret places in Salento.",
    start: "Start",
    hudStars: "Stars",
    musicOn: "‚èπÔ∏è Music",
    musicOff: "üéµ Music",
    replay: "‚ü≤ Replay",
    ask: (info) => `Tell me, where is ${info}?`,
    success: (name) => `Great, that‚Äôs exactly it: ${name}!`,
    errTitle: "‚ö†Ô∏è Asset issue",
    mapNotLoaded: (url)=>`Map not loaded: ${url}`,
    assetMissing: (who,url)=>`‚Ä¢ ${who} missing: "${url}"`
  }
};

/* Map d‚Äôalias et normalisation */
const SUPPORTED = Object.keys(I18N);
const LOCALE_ALIASES = {
  "fr-ca":"fr","fr-ch":"fr","fr-be":"fr","fr-lu":"fr","fr-mc":"fr",
  "it-ch":"it",
  "es-419":"es","es-mx":"es","es-ar":"es","es-cl":"es","es-co":"es","es-pe":"es","es-es":"es",
  "en-gb":"en","en-us":"en","en-au":"en","en-ca":"en","en-nz":"en","en-ie":"en","en-in":"en"
};

function getLangOverride(){
  try{
    const url = new URL(location.href);
    const p = (url.searchParams.get("lang")||"").trim().toLowerCase();
    if (p) { localStorage.setItem("__lang__", p); return p; }
    const saved = (localStorage.getItem("__lang__")||"").trim().toLowerCase();
    if (saved) return saved;
  }catch(_){}
  return "";
}

function detectLang(){
  const override = getLangOverride();
  const candidatesRaw = [];
  if (override) candidatesRaw.push(override);
  if (Array.isArray(navigator.languages)) candidatesRaw.push(...navigator.languages);
  if (navigator.language) candidatesRaw.push(navigator.language);
  if (navigator.userLanguage) candidatesRaw.push(navigator.userLanguage);
  candidatesRaw.push("en");
  for (let c of candidatesRaw){
    if (!c) continue;
    c = String(c).replace("_","-").toLowerCase();
    const alias = LOCALE_ALIASES[c];
    const primary = c.split("-")[0];
    const tryList = [c, alias, primary].filter(Boolean);
    for (const v of tryList){ if (SUPPORTED.includes(v)) return v; }
  }
  return "en";
}

/* Setter */
function setLang(langCode){
  const lc = String(langCode||"").trim().toLowerCase();
  const alias = LOCALE_ALIASES[lc] || lc.split("-")[0];
  const final = SUPPORTED.includes(alias) ? alias : "en";
  localStorage.setItem("__lang__", final);
  location.reload();
}

/* Applique les libell√©s statiques */
const LANG = detectLang();
const t = I18N[LANG] || I18N.en;

(function applyI18N(){
  document.documentElement.lang = LANG;
  document.title = t.title + " ‚Äî Salento";
  const $ = (id)=>document.getElementById(id);
  $("titleH1").textContent = t.title;
  $("subtitleP").textContent = t.subtitle;
  $("startBtn").textContent = t.start;
  $("hudLabel").textContent = t.hudStars;
  $("musicBtn").textContent = t.musicOff;
  $("replayFloat").textContent = t.replay;
  $("errTitle").textContent = t.errTitle;
})();

/* =========================================================
   BOOT / REPLAY
========================================================= */
window.startGame = function(){
  try{
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('touch').classList.add('show');
    document.getElementById('musicBtn').style.display = 'inline-block';
    resetGame(false);
    if (typeof startMusic === 'function') startMusic(); // iOS: geste utilisateur
    if (typeof resize === 'function') resize();
    window.running = true;
    requestAnimationFrame(loop);
  }catch(e){ alert('Start error: '+e.message); }
};
document.getElementById('startBtn').addEventListener('click', ()=>window.startGame && window.startGame());
document.getElementById('replayFloat').addEventListener('click', ()=>{ resetGame(true); window.startGame(); });

/* Debug √† l‚Äô√©cran */
function debug(msg){const box=document.getElementById('debugBox');box.style.display='block';box.innerHTML+=(box.innerHTML?'<br>':'')+'‚ö†Ô∏è '+msg;}
window.addEventListener('error',e=>debug(e.message));
window.addEventListener('unhandledrejection',e=>debug(e.reason&&e.reason.message?e.reason.message:e.reason));

/* =========================================================
   ASSETS
========================================================= */
const MAP_URL       = "assets/salento-map.PNG" + (window.APP_Q || "");
const BIRD_URL      = "assets/aracne .PNG"      + (window.APP_Q || "");       /* <-- espace retir√© */
const TARANTULA_URL = "assets/tarantula .PNG"   + (window.APP_Q || "");       /* <-- espace 
// === PATCH 1: sprites ennemis ===
const CROW_URL   = "assets/crow.PNG"       + (window.APP_Q || "");
const JELLY_URL  = "assets/jellyfish.PNG"  + (window.APP_Q || "");

// Images sprites
const crowImg  = new Image();
const jellyImg = new Image();

crowImg.onerror  = () => assetFail("Corbeau (sprite)",  CROW_URL);
jellyImg.onerror = () => assetFail("M√©duse (sprite)",   JELLY_URL);

crowImg.src  = CROW_URL;
jellyImg.src = JELLY_URL;

/* ===== Canvas & UI refs ===== */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

/* UI refs ‚Äî D√âFINIS AVANT tout appel √† resize() */
const touch     = document.getElementById('touch');
const scoreEl   = document.getElementById('score');
const starsEl   = document.getElementById('stars');
const tarTop    = document.getElementById('tarTop');
const tarAvatar = document.getElementById('tarAvatar');
const bdTitle   = document.getElementById('bdTitle');
const bdText    = document.getElementById('bdText');
const errBox    = document.getElementById('err');
const errText   = document.getElementById('errText');
const musicBtn  = document.getElementById('musicBtn');
const replayBtn = document.getElementById('replayFloat');
const hudEl     = document.getElementById('hud');
tarAvatar.src   = TARANTULA_URL;
/* Avatars sur l‚Äô√©cran de d√©marrage */
document.getElementById('heroAr').src = BIRD_URL;
document.getElementById('heroTa').src = TARANTULA_URL;

/* Resize */
let W=0,H=0,dpr=1;
function resize(){
  dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  W=canvas.clientWidth=canvas.parentElement.clientWidth;
  H=canvas.clientHeight=canvas.parentElement.clientHeight;
  canvas.width=W*dpr; canvas.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
}
resize(); addEventListener('resize', resize);

/* Images */
const mapImg=new Image(), birdImg=new Image(), spiderImg=new Image();
mapImg.onload=()=>{ drawSplash(); };
mapImg.onerror=()=>assetFail('Carte/Map', MAP_URL, true);
birdImg.onerror=()=>assetFail('Aracne', BIRD_URL);
spiderImg.onerror=()=>assetFail('Tarantula', TARANTULA_URL);
mapImg.src=MAP_URL; birdImg.src=BIRD_URL; spiderImg.src=TARANTULA_URL;
function assetFail(who,url,showPlaceholder){
  errBox.style.display='block';
  errText.innerHTML += (errText.innerHTML? "<br>":"") + t.assetMissing(who,url);
  if(showPlaceholder) drawSplash(true);
}

/* =========================================================
   DONN√âES / POIS / JOUEUR
========================================================= */
const SHIFT_COAST = { x:0.045, y:0.026 };
const SHIFT_EAST  = 0.04;

const POIS = [
  { key:"otranto",       x:0.86+SHIFT_EAST+SHIFT_COAST.x,       y:0.48+SHIFT_COAST.y },
  { key:"portobadisco",  x:0.80+SHIFT_EAST+SHIFT_COAST.x,       y:0.56+SHIFT_COAST.y },
  { key:"santacesarea",  x:0.74+SHIFT_EAST+SHIFT_COAST.x+0.010, y:0.60+SHIFT_COAST.y+0.008 },
  { key:"castro",        x:0.72+SHIFT_EAST+SHIFT_COAST.x+0.012, y:0.65+SHIFT_COAST.y+0.008 },
  { key:"ciolo",         x:0.66+SHIFT_EAST+SHIFT_COAST.x+0.070, y:0.78+SHIFT_COAST.y+0.006 },
  { key:"leuca",         x:0.64+SHIFT_COAST.x+0.10,             y:0.90+SHIFT_COAST.y },
  { key:"gallipoli",     x:0.27,                                y:0.62 },
  { key:"portocesareo",  x:0.22,                                y:0.46 },
  { key:"nardo",         x:0.38,                                y:0.50 },
  { key:"lecce",         x:0.53,                                y:0.28 }
];

const player   = { x:0.55, y:0.25, speed:0.0048, size:0.11 };
let collected= new Set();

/* =========================================================
   Textes POI multi-langues (pack + helpers)
========================================================= */
const POI_TEXT = {
  fr: {
    otranto:      { name:"Otranto ‚Äî Cath√©drale",            info:"la cath√©drale aux mosa√Øques m√©di√©vales et la chapelle des 800 martyrs" },
    portobadisco: { name:"Porto Badisco ‚Äî Calanque",        info:"la grande calanque aux eaux turquoises entour√©e de falaises" },
    santacesarea: { name:"Santa Cesarea Terme",             info:"les thermes soufr√©s et la Villa Sticchi en bord de mer" },
    castro:       { name:"Castro ‚Äî Castrum Minervae",       info:"la grotte Zinzulusa et le souvenir du temple d‚ÄôAth√©na" },
    ciolo:        { name:"Il Ciolo",                         info:"le petit fjord avec le grand pont routier" },
    leuca:        { name:"Santa Maria di Leuca",             info:"le phare tr√®s haut et la cascade monumentale du Finibus Terrae" },
    gallipoli:    { name:"Gallipoli",                        info:"la vieille ville b√¢tie sur un √Ælot reli√© par un pont" },
    portocesareo: { name:"Porto Cesareo",                    info:"les plages claires et la r√©serve marine" },
    nardo:        { name:"Nard√≤",                            info:"le centre baroque et Porto Selvaggio tout proche" },
    lecce:        { name:"Lecce",                            info:"le baroque en pietra leccese, Santa Croce et le Duomo" }
  },
  en: {
    otranto:      { name:"Otranto ‚Äî Cathedral",              info:"the cathedral with medieval mosaics and the Chapel of the 800 Martyrs" },
    portobadisco: { name:"Porto Badisco ‚Äî Inlet",            info:"the large turquoise cove surrounded by cliffs" },
    santacesarea: { name:"Santa Cesarea Terme",              info:"the sulfur baths and seaside Villa Sticchi" },
    castro:       { name:"Castro ‚Äî Castrum Minervae",        info:"the Zinzulusa cave and the memory of Athena‚Äôs temple" },
    ciolo:        { name:"Il Ciolo",                         info:"the tiny fjord with the high road bridge" },
    leuca:        { name:"Santa Maria di Leuca",             info:"the tall lighthouse and the monumental Finibus Terrae cascade" },
    gallipoli:    { name:"Gallipoli",                        info:"the old town on an islet linked by a bridge" },
    portocesareo: { name:"Porto Cesareo",                    info:"clear beaches and the marine reserve" },
    nardo:        { name:"Nard√≤",                            info:"the baroque center and nearby Porto Selvaggio" },
    lecce:        { name:"Lecce",                            info:"baroque in pietra leccese, Santa Croce and the Duomo" }
  },
  it: {
    otranto:      { name:"Otranto ‚Äî Cattedrale",             info:"la cattedrale con i mosaici medievali e la Cappella dei 800 Martiri" },
    portobadisco: { name:"Porto Badisco ‚Äî Cala",             info:"la grande cala turchese circondata da scogliere" },
    santacesarea: { name:"Santa Cesarea Terme",              info:"le terme sulfuree e la Villa Sticchi sul mare" },
    castro:       { name:"Castro ‚Äî Castrum Minervae",        info:"la grotta Zinzulusa e il ricordo del tempio di Atena" },
    ciolo:        { name:"Il Ciolo",                         info:"il piccolo fiordo con l‚Äôalto ponte stradale" },
    leuca:        { name:"Santa Maria di Leuca",             info:"l‚Äôaltissimo faro e la cascata monumentale del Finibus Terrae" },
    gallipoli:    { name:"Gallipoli",                        info:"il centro storico su un isolotto collegato da un ponte" },
    portocesareo: { name:"Porto Cesareo",                    info:"spiagge chiare e l‚Äôarea marina protetta" },
    nardo:        { name:"Nard√≤",                            info:"il centro barocco e Porto Selvaggio vicino" },
    lecce:        { name:"Lecce",                            info:"barocco in pietra leccese, Santa Croce e il Duomo" }
  },
  es: {
    otranto:      { name:"Otranto ‚Äî Catedral",               info:"la catedral con mosaicos medievales y la Capilla de los 800 M√°rtires" },
    portobadisco: { name:"Porto Badisco ‚Äî Cala",             info:"la gran cala turquesa rodeada de acantilados" },
    santacesarea: { name:"Santa Cesarea Terme",              info:"los ba√±os sulfurosos y la Villa Sticchi junto al mar" },
    castro:       { name:"Castro ‚Äî Castrum Minervae",        info:"la cueva Zinzulusa y el recuerdo del templo de Atenea" },
    ciolo:        { name:"Il Ciolo",                         info:"el peque√±o fiordo con el alto puente de carretera" },
    leuca:        { name:"Santa Maria di Leuca",             info:"el faro alt√≠simo y la cascada monumental del Finibus Terrae" },
    gallipoli:    { name:"Gallipoli",                        info:"el casco antiguo en un islote unido por un puente" },
    portocesareo: { name:"Porto Cesareo",                    info:"playas claras y la reserva marina" },
    nardo:        { name:"Nard√≤",                            info:"el centro barroco y el cercano Porto Selvaggio" },
    lecce:        { name:"Lecce",                            info:"barroco en pietra leccese, Santa Croce y el Duomo" }
  }
};
function poiPack(key){
  const pack = POI_TEXT[LANG] || POI_TEXT.en;
  const fr   = POI_TEXT.fr;
  return (pack && pack[key]) || (fr && fr[key]) || { name:key, info:key };
}
function poiName(key){ return poiPack(key).name; }
function poiInfo(key){ return poiPack(key).info || poiPack(key).name; }

/* L‚Äôordre de questions al√©atoire √† chaque partie */
let QUEST = [];
let currentIdx = 0;

/* UI r√©serves */
const UI_BOTTOM = 160;
const UI_TOP    = 120;

/* Labels √©ph√©m√®res */
const floatingLabels = []; // {text,x,y,age,life}

/* Emp√™che le mouvement pendant messages de succ√®s */
let inputLocked = false;

/* =========================================================
   AUDIO
========================================================= */
let audioCtx=null, masterGain=null, musicOn=false, loopTimer=null, finaleLoopTimer=null;
function createAudioOnce(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain(); masterGain.gain.value = 0.58; masterGain.connect(audioCtx.destination);
  const b = audioCtx.createBuffer(1,1,22050); const s = audioCtx.createBufferSource(); s.buffer=b; s.connect(masterGain); s.start(0);
}
async function startMusic(){
  try{
    createAudioOnce();
    if (audioCtx.state==='suspended') await audioCtx.resume();
    ping(720,0.20);
    musicOn=true; musicBtn.textContent=t.musicOn;
    playPhrase();
  }catch(e){}
}
function stopMusic(){
  musicOn=false;
  if(loopTimer){ clearTimeout(loopTimer); loopTimer=null; }
  if(audioCtx && audioCtx.state!=="closed"){ audioCtx.suspend(); }
  musicBtn.textContent=t.musicOff;
}
function toggleMusic(){ musicOn?stopMusic():startMusic(); }
musicBtn.addEventListener('click', toggleMusic);

function scheduleSquare(freq,start,dur=0.25,amp=0.30){
  if(!audioCtx||!masterGain) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type='square'; o.frequency.value=freq;
  g.gain.setValueAtTime(amp,start);
  g.gain.exponentialRampToValueAtTime(0.001,start+dur);
  o.connect(g).connect(masterGain);
  o.start(start); o.stop(start+dur);
}
function ping(freq=440, amp=0.2){ if(!audioCtx||!masterGain) return; const t=audioCtx.currentTime; scheduleSquare(freq,t,0.16,amp); }
function playPhrase(){
  if(!musicOn||!audioCtx) return;
  const notes=[262,294,330,349,392,440,494,523];
  let t=audioCtx.currentTime;
  notes.forEach(f=>{ scheduleSquare(f,t,0.24,0.28); t+=0.28; });
  loopTimer=setTimeout(playPhrase,2800);
}
function starEmphasis(){ if(!audioCtx||!masterGain) return; const base=audioCtx.currentTime; [784,880,988,1175].forEach((f,i)=> scheduleSquare(f, base+i*0.08, 0.18, 0.46)); }
function failSfx(){ if(!audioCtx||!masterGain) return; const t=audioCtx.currentTime; scheduleSquare(196,t,0.20,0.42); scheduleSquare(165,t+0.18,0.20,0.36); scheduleSquare(147,t+0.34,0.25,0.32); }

function playFinaleLong(){
  if(!audioCtx||!masterGain) return;
  if(loopTimer){ clearTimeout(loopTimer); loopTimer=null; }
  const t0=audioCtx.currentTime+0.05;
  const seq1=[523,659,784,988,1175,1319], seq2=[1319,1175,988,784,659,523], chord=[523,659,784];
  let t=t0;
  seq1.forEach((f,i)=> scheduleSquare(f, t + i*0.14, 0.24, 0.58)); t+=seq1.length*0.14 + 0.12;
  seq2.forEach((f,i)=> scheduleSquare(f, t + i*0.14, 0.24, 0.52)); t+=seq2.length*0.14 + 0.24;
  chord.forEach(f=> scheduleSquare(f,   t, 1.0, 0.50)); t+=1.05;
  chord.forEach(f=> scheduleSquare(f*2, t, 1.0, 0.48));
  finaleLoopTimer = setTimeout(playFinaleLong, 10500);
}

/* =========================================================
   GAMEPLAY+ : Ennemis & Bonus & Score
========================================================= */
let enemies = [], bonuses = [];
let enemySpawnAt = 0, bonusSpawnAt = 0;
let collisionCount = 0, bonusCount = 0;
let playerSlowTimer = 0; // ralentissement temporaire apr√®s collision

/* ---- CONFIG √©quilibrage ---- */
const MAX_ENEMIES        = 4;
const ENEMY_LIFETIME     = 14;     // s
const ENEMY_BASE_SPAWN   = 4200;   // ms
const ENEMY_SPAWN_JITTER = 2600;   // ms
const BONUS_LIFETIME     = 4;      // s
const COLLIDE_PX         = 36;     // rayon collision px

/* ---- SHAKE joueur (visuel) ---- */
let hitShake = 0;                      // temps restant de shake (s)
const HIT_SHAKE_MAX   = 2.4;           // clamp max ~2.4s
const HIT_SHAKE_DECAY = 1.0;           // s^-1

/* vitesse effective du joueur (ralenti si touch√©) */
function currentSpeed(){
  const base = player.speed;
  const factor = (playerSlowTimer > 0) ? 0.45 : 1.0;
  return base * factor;
}

/* ------------------------------
   Spawns
------------------------------ */
// === PATCH 2: types d‚Äôennemis unifi√©s ===
const ENEMY = { JELLY: "jelly", CROW: "crow" };

function spawnEnemy(){
  if (enemies.length >= MAX_ENEMIES) return;
  const type  = (Math.random() < 0.5) ? ENEMY.JELLY : ENEMY.CROW;
  const x     = Math.random()*0.9 + 0.05;
  const y     = Math.random()*0.9 + 0.05;
  const speed = (type === ENEMY.JELLY ? 0.06 : 0.10);
  const dir   = Math.random() * Math.PI * 2;
  enemies.push({
    type, x, y,
    vx: Math.cos(dir)*speed,
    vy: Math.sin(dir)*speed,
    r:  0.035,
    t:  0,
    bornAt: performance.now(),
    state: "normal",
    fleeUntil: 0
  });
}

function spawnBonus(){
  bonuses.push({
    x: Math.random()*0.9 + 0.05,
    y: Math.random()*0.9 + 0.05,
    life: BONUS_LIFETIME,
    age: 0,
    r: 0.028,
    pulse: 0
  });
}

/* =========================================================
   FEUX D‚ÄôARTIFICE + DANSE
========================================================= */
let fireworks=[], finale=false, finaleTimer=0, finaleZoom=1, dancePhase=0;
let danceBird={x:0,y:0,scale:1,angle:0}, danceSpider={x:0,y:0,scale:1,angle:0};

function launchFireworksBurst(cx,cy,parts=42, big=true){
  for(let i=0;i<parts;i++){
    const ang=(i/parts)*Math.PI*2, speed=(big?160:90)+Math.random()*(big?180:90);
    fireworks.push({
      x:cx, y:cy, vx:Math.cos(ang)*speed, vy:Math.sin(ang)*speed,
      life:1.3+Math.random()*.8, age:0,
      color:`hsl(${Math.floor(Math.random()*360)},82%,60%)`,
      baseSize: big?3.6:2.2
    });
  }
}
function updateFireworks(dt){
  const g=140;
  fireworks = fireworks.filter(p=>{
    p.age+=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=g*dt*0.5;
    return p.age<p.life;
  });
}
function drawFireworks(){
  ctx.save();
  if(finale){
    const cx=W/2, cy=(UI_TOP + (H-UI_BOTTOM-UI_TOP)/2);
    ctx.translate(cx,cy); ctx.scale(finaleZoom,finaleZoom); ctx.translate(-cx,-cy);
  }
  for(const p of fireworks){
    const a=1-(p.age/p.life);
    ctx.globalAlpha=Math.max(0,a);
    ctx.fillStyle=p.color;
    const r=(p.baseSize+(finale?2.0:0))*(1+0.6*(1-a));
    ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}
function triggerFireworksShow(){
  const slots=[0,500,1000,1600,2200,3000];
  slots.forEach((t,i)=> setTimeout(()=> {
    launchFireworksBurst(
      (0.2+0.6*Math.random())*W,
      UI_TOP+(0.1+0.7*Math.random())*(H-UI_BOTTOM-UI_TOP),
      40+(i*4), true
    );
  }, t));
}

/* =========================================================
   UPDATE GAMEPLAY+ (par frame)
========================================================= */
function updateGameplayPlus(dt, ox, oy, dw, dh, bx, by){
  const now = performance.now();

  // spawns contr√¥l√©s
  if(!finale){
    if (now > enemySpawnAt){
      if (enemies.length < MAX_ENEMIES) spawnEnemy();
      enemySpawnAt = now + ENEMY_BASE_SPAWN + Math.random()*ENEMY_SPAWN_JITTER;
    }
    if (now > bonusSpawnAt){
      spawnBonus();
      bonusSpawnAt = now + 4200 + Math.random()*3000;
    }
  }

  // vieillissement / auto-despawn ennemis
  enemies = enemies.filter(e => (now - (e.bornAt||now)) < ENEMY_LIFETIME*1000);

  // timers joueur
  if (playerSlowTimer > 0) playerSlowTimer -= dt;
  if (hitShake > 0)        hitShake = Math.max(0, hitShake - dt * HIT_SHAKE_DECAY);

  // mouvement ennemis (+ fuite)
  const PAD = 0.02;
  for(const e of enemies){
    e.t += dt;

    if (e.state === "flee"){
      if (now >= e.fleeUntil){
        e._remove = true;
      } else {
        e.vx *= 0.995; e.vy *= 0.995;
      }
    } else if (e.type === "jelly"){
      e.vx += Math.sin(e.t*1.7)*0.0008;
      e.vy += Math.cos(e.t*1.3)*0.0008;
    }

    e.x += e.vx*dt; e.y += e.vy*dt;

    // rebond bords
    if(e.x < PAD || e.x > 1-PAD){ e.vx *= -1; e.x = Math.max(PAD, Math.min(1-PAD, e.x)); }
    if(e.y < PAD || e.y > 1-PAD){ e.vy *= -1; e.y = Math.max(PAD, Math.min(1-PAD, e.y)); }
  }
  enemies = enemies.filter(e => !e._remove);

  // collisions joueur <-> ennemis
  for(const e of enemies){
    if (e.state === "flee") continue;
    const ex = ox + e.x*dw, ey = oy + e.y*dh;
    const d  = Math.hypot(bx - ex, by - ey);
    if(d < COLLIDE_PX){
      const ang = Math.atan2(by - ey, bx - ex);
      player.x = Math.max(0, Math.min(1, player.x + Math.cos(ang)*0.02));
      player.y = Math.max(0, Math.min(1, player.y + Math.sin(ang)*0.02));

      collisionCount++;
      playerSlowTimer = 1.25;
      hitShake = Math.min(HIT_SHAKE_MAX, hitShake + 0.6);
      failSfx();

      const fleeSpeed = 0.38;
      const away = Math.atan2((ey - by), (ex - bx));
      e.vx = Math.cos(away) * fleeSpeed;
      e.vy = Math.sin(away) * fleeSpeed;
      e.state = "flee";
      e.fleeUntil = now + 1600 + Math.random()*700;
    }
  }

  // Bonus pickup
  for(let i=bonuses.length-1; i>=0; i--){
    const b = bonuses[i];
    b.age += dt; b.pulse += dt;
    if(b.age > b.life){ bonuses.splice(i,1); continue; }
    const bpx = ox + b.x*dw, bpy = oy + b.y*dh;
    if(Math.hypot(bx - bpx, by - bpy) < 36){
      bonusCount++;
      ping(880, 0.35);
      floatingLabels.push({ text:"Bonus!", x:bpx, y:bpy-16, age:0, life:1.5 });
      bonuses.splice(i,1);
      playerSlowTimer = 0;
      hitShake = Math.min(HIT_SHAKE_MAX, hitShake + 0.2);
    }
  }
}

/* =========================================================
   Bulle / Questions
========================================================= */
function askQuestionFor(p){
  if(!p) return;
  bdTitle.textContent = "Tarantula";
  bdText.textContent  = t.ask( poiInfo(p.key) );
  tarTop.classList.add('show');
}
function showTarantulaSuccess(p){
  bdTitle.textContent="Tarantula";
  bdText.textContent=t.success(p.name.split(" ‚Äî ")[0]);
  tarTop.classList.add('show');
}

/* =========================================================
   Utils: shuffle (Fisher‚ÄìYates)
========================================================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* =========================================================
   RENDU
========================================================= */
window.running=false;
let lastTS=0, frameDT=0, lastFailAt=0; const FAIL_COOLDOWN=900;

/* ====== Zoom global de la carte ====== */
const MAP_ZOOM = 1.30; // ‚âà +30%

function drawStarfish(cx,cy,R){
  ctx.save(); ctx.shadowColor='rgba(0,0,0,.2)'; ctx.shadowBlur=6; ctx.shadowOffsetY=3;
  ctx.beginPath(); const pts=5,inner=R*0.45;
  for(let i=0;i<pts*2;i++){
    const ang=(Math.PI/pts)*i - Math.PI/2;
    const r=(i%2===0)?R:inner;
    const x=cx+Math.cos(ang)*r, y=cy+Math.sin(ang)*r;
    if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.closePath(); ctx.fillStyle='#d26f45'; ctx.strokeStyle='#8c3f28'; ctx.lineWidth=3; ctx.fill(); ctx.stroke(); ctx.restore();
}

// === PATCH 3: rendu des ennemis (sprite + fallback) ===
function drawEnemy(e, ox, oy, dw, dh){
  const x = ox + e.x*dw, y = oy + e.y*dh;
  ctx.save();

  // Transparence s‚Äôil est en fuite (d√©j√† dans ton code original)
  if (e.state === "flee"){
    const remain = Math.max(0, e.fleeUntil - performance.now()) / 700;
    ctx.globalAlpha = Math.max(0.12, Math.min(1, remain));
  }

  const SIZE = 42;

  if (e.type === ENEMY.JELLY){
    // Sprite si dispo, sinon fallback ‚Äúm√©duse‚Äù vectoriel existant
    if (jellyImg.complete && jellyImg.naturalWidth){
      ctx.drawImage(jellyImg, x - SIZE/2, y - SIZE/2, SIZE, SIZE);
    } else {
      // Fallback: d√¥me + tentacules (ton ancien rendu)
      ctx.fillStyle = "rgba(123,200,255,0.85)";
      ctx.beginPath(); ctx.arc(x,y,18,Math.PI,0); ctx.fill();
      ctx.fillRect(x-18,y,36,8);
      for(let i=0;i<5;i++){
        ctx.beginPath();
        ctx.moveTo(x-14+i*7, y+8);
        ctx.quadraticCurveTo(x-14+i*7, y+22+(i%2?6:-4), x-14+i*7, y+32);
        ctx.strokeStyle = "rgba(80,150,220,0.9)";
        ctx.lineWidth = 2; ctx.stroke();
      }
    }
  } else { // ENEMY.CROW
    // On oriente le corbeau dans sa direction de vol
    const ang = Math.atan2(e.vy, e.vx);
    ctx.translate(x,y); ctx.rotate(ang);

    if (crowImg.complete && crowImg.naturalWidth){
      ctx.drawImage(crowImg, -SIZE/2, -SIZE/2, SIZE, SIZE);
    } else {
      // Fallback triangle ‚Äúoiseau‚Äù
      ctx.fillStyle = "#242424";
      ctx.beginPath();
      ctx.moveTo(-20,0); ctx.lineTo(10,-8); ctx.lineTo(10,8); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.ellipse(-6,0,10,6,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle="#ffd400"; ctx.fillRect(10,-2,6,4); // bec
    }
  }

  ctx.restore();
}
  
function starSVG(fill){
  const f=fill||"#d26f45";
  return "data:image/svg+xml;base64,"+btoa(
    `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 5 L61 36 L94 36 L67 55 L77 88 L50 68 L23 88 L33 55 L6 36 L39 36 Z' fill='${f}' stroke='#8c3f28' stroke-width='4' stroke-linejoin='round'/></svg>`
  );
}
function refreshStars(){
  const n = collected.size;
  scoreEl.textContent = `${n}/10`;
  starsEl.innerHTML='';
  for(let i=0;i<10;i++){
    const im=new Image();
    im.className='star';
    im.src=starSVG(i<n?"#d26f45":"#f0c9a7");
    starsEl.appendChild(im);
  }
}

function drawEnemies() {
  for (const e of enemies) {
    const ex = e.x * W, ey = e.y * H;
    const size = 48; // taille des sprites (ajuste selon ton PNG)

    if (e.type === "jellyfish") {
      if (jellyfishImg.complete) {
        ctx.drawImage(jellyfishImg, ex - size / 2, ey - size / 2, size, size);
      } else {
        ctx.fillStyle = "purple";
        ctx.beginPath();
        ctx.arc(ex, ey, size / 2.5, 0, Math.PI * 2);
        ctx.fill();
      }
    } else if (e.type === "crow") {
      if (crowImg.complete) {
        ctx.drawImage(crowImg, ex - size / 2, ey - size / 2, size, size);
      } else {
        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.moveTo(ex - size / 2, ey);
        ctx.lineTo(ex, ey - size / 2);
        ctx.lineTo(ex + size / 2, ey);
        ctx.closePath();
        ctx.fill();
      }
    }
  }
}
  
function drawBonus(b, ox, oy, dw, dh){
  const x = ox + b.x*dw, y = oy + b.y*dh;
  const r = 10 + Math.sin(b.pulse*6)*2;
  ctx.save();
  ctx.globalAlpha = 0.9 * (1 - b.age/b.life);
  ctx.fillStyle = "#ffe06b";
  ctx.strokeStyle = "#8c6a1a";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<5;i++){
    const a = i*2*Math.PI/5 - Math.PI/2;
    const xi=x+Math.cos(a)*r, yi=y+Math.sin(a)*r;
    if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi);
  }
  ctx.closePath(); ctx.fill(); ctx.stroke();
  ctx.restore();
}
refreshStars();

function drawLabels(dt){
  const MARGIN = 8, PAD = 6, LINE_H = 20, ARROW = 8;
  for (let i = floatingLabels.length - 1; i >= 0; i--) {
    const L = floatingLabels[i];
    L.age += dt;
    const tprog = L.age / L.life;
    if (tprog >= 1) { floatingLabels.splice(i, 1); continue; }
    const alpha = 1 - tprog;
    const lift  = 10 * tprog;
    let baseX = L.x + 10;
    let baseY = (L.y - 10 - lift);

    ctx.save();
    ctx.font = "bold 16px system-ui";
    const text = L.text;
    const textW = Math.ceil(ctx.measureText(text).width);
    const boxW = textW + PAD * 2;
    const boxH = LINE_H + PAD * 2;

    let bx = baseX;
    let by = baseY - (LINE_H + PAD);
    const anchorX = L.x;
    const anchorY = L.y - lift;

    const topLimit = MARGIN;
    if (by - PAD < topLimit) { by = (L.y + 12) + PAD; baseY = by + LINE_H; }
    if (bx + boxW > W - MARGIN) bx = (W - MARGIN) - boxW;
    if (bx < MARGIN)            bx = MARGIN;

    const textX = bx + PAD;
    const textY = baseY;
    const moved = (Math.hypot((bx + boxW/2) - anchorX, (by + boxH/2) - anchorY) > 16);

    ctx.globalAlpha = Math.max(0, alpha);
    ctx.shadowColor = "rgba(0,0,0,.15)";
    ctx.shadowBlur = 6; ctx.shadowOffsetY = 3;

    // bulle
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.strokeStyle = "rgba(0,0,0,0.15)";
    ctx.lineWidth = 1.5;
    const r = 8;
    ctx.beginPath();
    ctx.moveTo(bx + r, by);
    ctx.lineTo(bx + boxW - r, by);
    ctx.quadraticCurveTo(bx + boxW, by, bx + boxW, by + r);
    ctx.lineTo(bx + boxW, by + boxH - r);
    ctx.quadraticCurveTo(bx + boxW, by + boxH, bx + boxW - r, by + boxH);
    ctx.lineTo(bx + r, by + boxH);
    ctx.quadraticCurveTo(bx, by + boxH, bx, by + boxH - r);
    ctx.lineTo(bx, by + r);
    ctx.quadraticCurveTo(bx, by, bx + r, by);
    ctx.closePath();
    ctx.fill(); ctx.stroke();

    // bec
    if (moved) {
      ctx.beginPath();
      const midX = Math.max(bx + r, Math.min(bx + boxW - r, anchorX));
      if (by > anchorY) {
        ctx.moveTo(midX - ARROW, by);
        ctx.lineTo(midX + ARROW, by);
        ctx.lineTo(anchorX, anchorY);
      } else {
        ctx.moveTo(midX - ARROW, by + boxH);
        ctx.lineTo(midX + ARROW, by + boxH);
        ctx.lineTo(anchorX, anchorY);
      }
      ctx.closePath(); ctx.fill();
    }

    // texte
    ctx.shadowColor = "transparent";
    ctx.fillStyle = "#0e2b4a";
    ctx.strokeStyle = "rgba(255,255,255,.85)";
    ctx.lineWidth = 3;
    ctx.strokeText(text, textX, textY);
    ctx.fillText(text, textX, textY);

    // trait liaison
    if (moved) {
      ctx.beginPath();
      ctx.strokeStyle = "rgba(14,43,74,.35)";
      ctx.lineWidth = 1;
      ctx.moveTo(anchorX, anchorY);
      const targetX = Math.max(bx, Math.min(bx + boxW, anchorX));
      const targetY = (by > anchorY) ? by : (by + boxH);
      ctx.lineTo(targetX, targetY);
      ctx.stroke();
    }
    ctx.restore();
  }
}

function draw(ts){
  if(ts){
    if(!lastTS) lastTS=ts;
    frameDT=Math.min(0.05,(ts-lastTS)/1000); lastTS=ts;
    if(finale){
      updateFireworks(frameDT);
      finaleTimer+=frameDT; finaleZoom=Math.min(1.35,1+finaleTimer*0.12);
      dancePhase+=frameDT*2.4;
      const cx=W/2, cy=(UI_TOP + (H-UI_BOTTOM-UI_TOP)/2);
      danceBird.x+=(cx-90-danceBird.x)*0.06; danceBird.y+=(cy-danceBird.y)*0.06;
      danceSpider.x+=(cx+90-danceSpider.x)*0.06; danceSpider.y+=(cy-danceSpider.y)*0.06;
      danceBird.scale+=(1.65-danceBird.scale)*0.05; danceSpider.scale+=(1.55-danceSpider.scale)*0.05;
      danceBird.angle=Math.sin(dancePhase)*0.25; danceSpider.angle=Math.sin(dancePhase+Math.PI/2)*0.20;
    }
  }

  const mw=mapImg.naturalWidth||1920, mh=mapImg.naturalHeight||1080;
  const availW=W, availH=Math.max(200, H-UI_BOTTOM-UI_TOP);
  const baseScale = Math.min(availW/mw, availH/mh);
  const scale = baseScale * MAP_ZOOM;
  const dw=mw*scale, dh=mh*scale;
  const ox=(W-dw)/2;
  const oy=UI_TOP + (availH - dh)/2;

  ctx.clearRect(0,0,W,H);

  // Carte
  if (mapImg.complete && mapImg.naturalWidth) ctx.drawImage(mapImg,ox,oy,dw,dh);
  else { ctx.fillStyle="#bfe2f8"; ctx.fillRect(ox,oy,dw,dh); ctx.fillStyle="#0e2b4a"; ctx.font="16px system-ui"; ctx.fillText(t.mapNotLoaded(MAP_URL), ox+14, oy+24); }

  if(finale){ ctx.fillStyle="rgba(0,0,0,0.22)"; ctx.fillRect(0,UI_TOP,W,H-UI_BOTTOM-UI_TOP); }

  // POI
  for(const p of POIS){
    const x=ox+p.x*dw, y=oy+p.y*dh;
    if(collected.has(p.key)){
      drawStarfish(x, y-20, Math.max(14,Math.min(22,Math.min(W,H)*0.028)));
    }else{
      ctx.save(); ctx.strokeStyle='#b04123'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(x-6,y-6); ctx.lineTo(x+6,y+6);
      ctx.moveTo(x-6,y+6); ctx.lineTo(x+6,y-6); ctx.stroke();
      ctx.restore();
    }
  }

  // Chemin when all found
  if (!finale && collected.size === POIS.length){
    ctx.save();
    ctx.strokeStyle = "#7a4c25";
    ctx.lineWidth = 4; ctx.lineCap = "round"; ctx.lineJoin = "round";
    ctx.beginPath();
    const first = POIS[0];
    ctx.moveTo(ox + first.x*dw, oy + first.y*dh);
    for (let i=0;i<POIS.length-1;i++){
      const a=POIS[i], b=POIS[i+1];
      const ax=ox+a.x*dw, ay=oy+a.y*dh, bx=ox+b.x*dw, by=oy+b.y*dh;
      const mx=(ax+bx)/2, my=(ay+by)/2 + ((i%2?1:-1)*8);
      ctx.quadraticCurveTo(mx,my,bx,by);
    }
    ctx.stroke(); ctx.restore();
  }

  // Joueur (position/taille)
  const bw = Math.min(160, Math.max(90, dw*player.size));
  const bx = ox + player.x*dw, by = oy + player.y*dh;

  // gameplay+ sous le joueur
  if(!finale){
    updateGameplayPlus(frameDT, ox, oy, dw, dh, bx, by);
    for(const b of bonuses) drawBonus(b, ox, oy, dw, dh);
    for(const e of enemies) drawEnemy(e, ox, oy, dw, dh);
  }

  // Shake visuel du joueur (clamp√©)
  let shakeX = 0, shakeY = 0;
  if (hitShake > 0){
    const a = Math.min(1, hitShake / HIT_SHAKE_MAX);
    const mag = 6 * a;
    shakeX = (Math.random()*2-1) * mag;
    shakeY = (Math.random()*2-1) * mag;
  }

  // joueur
  if(!finale){
    if (birdImg.complete && birdImg.naturalWidth)
      ctx.drawImage(birdImg, bx-bw/2+shakeX, by-bw/2+shakeY, bw, bw);
    else { ctx.fillStyle="#333"; ctx.beginPath(); ctx.arc(bx+shakeX,by+shakeY,bw*0.35,0,Math.PI*2); ctx.fill(); }
  }

  // Succ√®s/√©chec et progression
  if(!finale && currentIdx < QUEST.length){
    const p = QUEST[currentIdx];
    const px = ox + p.x * dw, py = oy + p.y * dh;
    const onTarget = Math.hypot(bx - px, by - py) < 44;

    if(onTarget && !inputLocked){
      inputLocked = true;
      collected.add(p.key);
      refreshStars();
      starEmphasis();

      const nameShort = poiName(p.key);
      bdTitle.textContent = "Tarantula";
      bdText.textContent  = t.success(nameShort);
      tarTop.classList.add('show');

      floatingLabels.push({ text: nameShort, x: px, y: py - 22, age: 0, life: 2.0 });

      currentIdx++;

      if(currentIdx === QUEST.length){
        setTimeout(()=>{
          beginFinale(bx, by, ox + POIS[POIS.length - 1].x * dw, oy + POIS[POIS.length - 1].y * dh);
          replayBtn.style.display = 'inline-block';
          inputLocked = false;
        }, 1200);
      }else{
        setTimeout(()=>{
          askQuestionFor(QUEST[currentIdx]);
          inputLocked = false;
        }, 2000);
      }
    }else if(!onTarget){
      const now = performance.now();
      if(now - lastFailAt > FAIL_COOLDOWN){
        for(const q of POIS){
          if(q.key === p.key || collected.has(q.key)) continue;
          const qx = ox + q.x * dw, qy = oy + q.y * dh;
          if(Math.hypot(bx - qx, by - qy) < 44){ failSfx(); lastFailAt = now; break; }
        }
      }
    }
  }

  // Feux + Danse + Labels
  if(finale || fireworks.length>0) drawFireworks();
  if(!finale) drawLabels(frameDT);
  if(finale){
    drawDancer(birdImg,   danceBird.x,   danceBird.y,   bw*danceBird.scale,        danceBird.angle);
    drawDancer(spiderImg, danceSpider.x, danceSpider.y, bw*danceSpider.scale*0.9,  danceSpider.angle);
  }
}

function drawDancer(img, cx, cy, size, angle){
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle);
  if(img.complete && img.naturalWidth) ctx.drawImage(img, -size/2, -size/2, size, size);
  else { ctx.fillStyle="#333"; ctx.beginPath(); ctx.arc(0,0,size*0.35,0,Math.PI*2); ctx.fill(); }
  ctx.restore();
}

function loop(ts){ if(!window.running) return; draw(ts); requestAnimationFrame(loop); }

/* =========================================================
   FINALE & RESET
========================================================= */
function beginFinale(bx,by,lastPx,lastPy){
  finale=true;

  const stars = collected.size;
  const score = stars*100 + bonusCount*25 - collisionCount*15;
  let rank;
  if(score >= 1000)      rank = "H√©ros d‚ÄôAracne üï∏Ô∏è";
  else if(score >= 700)  rank = "Explorateur du Salento üêö";
  else                   rank = "Touriste √©gar√© üå±";

  setTimeout(()=>{
    bdTitle.textContent = "Tarantula";
    bdText.textContent  = `Final Score, Aracne : ${score} ‚Äî ${rank}\n(‚≠ê ${stars}, üéÅ ${bonusCount}, üí• ${collisionCount})`;
    tarTop.classList.add('show');
  }, 900);

  touch.classList.remove('show');
  tarTop.classList.add('show');

  danceBird.x=bx; danceBird.y=by; danceSpider.x=lastPx; danceSpider.y=lastPy;
  danceBird.scale=1.0; danceSpider.scale=1.0; dancePhase=0; finaleTimer=0; finaleZoom=1.0;

  if(loopTimer){ clearTimeout(loopTimer); loopTimer=null; }
  musicOn = false; musicBtn.textContent = t.musicOff;

  playFinaleLong();
  triggerFireworksShow();
  window.__fwInterval__ = setInterval(triggerFireworksShow, 4500);
}

function resetGame(hideOverlay){
  QUEST = shuffle(POIS);
  collected = new Set();
  currentIdx = 0;

  finale=false; fireworks.length=0; dancePhase=0; finaleTimer=0; finaleZoom=1;
  if(window.__fwInterval__){ clearInterval(window.__fwInterval__); window.__fwInterval__=null; }
  if(finaleLoopTimer){ clearTimeout(finaleLoopTimer); finaleLoopTimer=null; }
  replayBtn.style.display='none';
  refreshStars();
  player.x=0.55; player.y=0.25;
  inputLocked=false;

  enemies.length = 0; bonuses.length = 0;
  enemySpawnAt = performance.now() + 800;
  bonusSpawnAt = performance.now() + 1400;
  collisionCount = 0; bonusCount = 0; playerSlowTimer = 0;
  hitShake = 0;

  askQuestionFor(QUEST[currentIdx]);

  if(musicOn){ if(loopTimer){ clearTimeout(loopTimer); } playPhrase(); }
  if(hideOverlay){ const ov=document.getElementById('overlay'); ov.style.display='none'; }
}

/* =========================================================
   CONTR√îLES (D-pad)
========================================================= */
for(const el of document.querySelectorAll('.btn')){
  const dx=parseFloat(el.dataset.dx), dy=parseFloat(el.dataset.dy);
  let press=false, id=null;
  const step=()=>{ if(!press || finale || inputLocked) return;
    player.x = Math.max(0, Math.min(1, player.x + dx * currentSpeed()));
    player.y = Math.max(0, Math.min(1, player.y + dy * currentSpeed()));
    id=requestAnimationFrame(step);
  };
  el.addEventListener('touchstart',e=>{press=true;step();e.preventDefault();},{passive:false});
  el.addEventListener('touchend',()=>{press=false;cancelAnimationFrame(id);});
}

/* =========================================================
   SPLASH
========================================================= */
function drawSplash(force){
  resize();
  if (mapImg.complete && mapImg.naturalWidth){
    const mw=mapImg.naturalWidth, mh=mapImg.naturalHeight;
    const availW=W, availH=Math.max(200, H - UI_BOTTOM - UI_TOP);
    const baseScale = Math.min(availW/mw, availH/mh);
    const scale = baseScale * MAP_ZOOM;
    const dw=mw*scale, dh=mh*scale;
    const ox=(W-dw)/2, oy=UI_TOP + (availH - dh)/2;
    ctx.clearRect(0,0,W,H);
    ctx.drawImage(mapImg,ox,oy,dw,dh);
  } else if (force){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#bfe2f8"; ctx.fillRect(0,0,W,H);
    ctx.fillStyle="#0e2b4a"; ctx.font="16px system-ui";
    ctx.fillText(t.mapNotLoaded(MAP_URL), 14, 28);
  }
}

/* Premi√®re devinette au chargement (overlay visible) */
askQuestionFor(POIS[0]); // placeholder visuel avant start
</script>
</body>
</html>
