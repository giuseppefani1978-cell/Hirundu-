<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Salento ‚Äî Aracne & Tarantula (Chasse au tr√©sor)</title>
<style>
  /* ===== Base ===== */
  html,body{height:100%;margin:0;background:#f6f1e1;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{-webkit-tap-highlight-color:transparent}
  .wrap{display:flex;flex-direction:column;height:100%}
  .game{position:relative;flex:1;overflow:hidden}
  canvas{width:100%;height:100%;display:block;background:#e2eef7;touch-action:none}

  /* ===== Overlay ===== */
  .overlay{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(246,241,225,.84);backdrop-filter:blur(3px);z-index:30;pointer-events:auto
  }
  .card{width:min(560px,92vw);border:2px solid #c8b37a;border-radius:14px;background:#fffdf5;box-shadow:0 10px 26px rgba(0,0,0,.18);padding:18px;text-align:center}
  .card h1{margin:0 0 6px 0;font-size:22px}
  .card p{margin:6px 0 14px 0;opacity:.82}
  .card button{border:1px solid #c8b37a;background:#ffe8a6;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer;pointer-events:auto}

  /* ===== HUD ===== */
  .hud{position:absolute;left:10px;top:10px;background:rgba(255,248,220,.96);border:2px solid #c8b37a;border-radius:10px;padding:8px 10px;font-size:14px;z-index:12}
  .stars{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
  .star{width:18px;height:18px;opacity:.95}

  /* ===== Bulle Tarantula ===== */
  .tarBox{position:absolute;display:none;align-items:flex-start;gap:8px;z-index:20;transform-origin:left bottom;transition:transform .15s ease,opacity .15s ease}
  .tarBox.show{display:flex;opacity:1;transform:scale(1)}
  .tarBox.hide{opacity:0;transform:scale(.95)}
  .tarBox img{width:64px;height:64px;object-fit:contain;background:transparent !important;border:none !important;border-radius:0 !important;box-shadow:none !important;}
  .bdBubble{max-width:min(320px,56vw);background:#fff;border:1px solid #bbb;border-radius:14px;padding:10px 12px;box-shadow:0 4px 10px rgba(0,0,0,.12);position:relative;font-size:14px;line-height:1.25}
  .bdBubble:after{content:"";position:absolute;left:-10px;bottom:10px;border-width:10px;border-style:solid;border-color:transparent #bbb transparent transparent}
  .bdBubble:before{content:"";position:absolute;left:-9px;bottom:11px;border-width:9px;border-style:solid;border-color:transparent #fff transparent transparent}
  .bdTitle{font-weight:700;margin-bottom:4px}

  /* ===== D-pad ===== */
  .touch{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:none;gap:14px;align-items:center;z-index:18}
  .touch.show{display:flex}
  .dpad{display:grid;grid-template-columns:72px 72px 72px;grid-template-rows:72px 72px 72px;gap:12px}
  .btn{width:72px;height:72px;border-radius:14px;border:2px solid #c8b37a;background:#fff7de;display:flex;align-items:center;justify-content:center;user-select:none;touch-action:none;font-weight:800;font-size:22px;box-shadow:0 3px 0 #c8b37a}
  .btn:active{transform:translateY(1px)}

  /* ===== Boutons en haut ===== */
  #musicBtn{
    position:absolute;top:10px;right:10px;z-index:22;background:#ffe8a6;border:2px solid #c8b37a;border-radius:10px;padding:8px 12px;font-weight:700;display:none
  }
  #editorBtn{
    position:absolute;top:52px;right:10px;z-index:22;background:#d9f7ff;border:2px solid #6bb4c9;border-radius:10px;padding:8px 12px;font-weight:700;display:none
  }

  /* ===== Panneau √©diteur ===== */
  .editorPanel{
    position:absolute;right:10px;top:96px;z-index:25;background:#fff;border:2px solid #6bb4c9;border-radius:12px;padding:10px;width:min(320px,90vw);
    box-shadow:0 8px 18px rgba(0,0,0,.18);display:none
  }
  .editorPanel .row{margin:6px 0;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .editorPanel .title{font-weight:800}
  .editorPanel button{background:#eef8fb;border:1px solid #6bb4c9;border-radius:8px;padding:6px 10px;font-weight:600}

  /* ===== Erreurs assets & Debug ===== */
  .err{position:absolute;right:10px;top:10px;background:#ffefef;border:2px solid #d66;border-radius:10px;padding:8px 10px;font-size:12px;color:#900;z-index:40;max-width:min(320px,60vw)}
  .err b{display:block;margin-bottom:4px}
  #debugBox{position:fixed;left:10px;bottom:10px;z-index:9999;background:#ffefef;border:2px solid #d66;padding:8px 10px;border-radius:8px;font:12px/1.3 system-ui;max-width:80vw;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="game">
    <!-- Overlay -->
    <div class="overlay" id="overlay">
      <div class="card">
        <h1>Salento ‚Äî Aracne & Tarantula</h1>
        <p>Collecte les 10 √©toiles et d√©couvre les lieux secrets.</p>
        <button id="startBtn" type="button" onclick="window.startGame && window.startGame()">D√©marrer</button>
      </div>
    </div>

    <button id="musicBtn">üéµ Musique</button>
    <button id="editorBtn">üß≠ √âditer points</button>

    <div class="err" id="err" style="display:none"><b>‚ö†Ô∏è Probl√®me d‚Äôassets</b><div id="errText"></div></div>

    <canvas id="c"></canvas>

    <div class="hud"><div>√âtoiles : <span id="score">0</span>/10</div><div class="stars" id="stars"></div></div>

    <div class="tarBox" id="tarBox">
      <img id="tarAvatar" alt="Tarantula">
      <div class="bdBubble"><div class="bdTitle" id="bdTitle">Tarantula</div><div id="bdText"></div></div>
    </div>

    <div class="touch" id="touch">
      <div class="dpad">
        <div></div> <div class="btn" data-dx="0" data-dy="-1">‚Üë</div> <div></div>
        <div class="btn" data-dx="-1" data-dy="0">‚Üê</div> <div></div> <div class="btn" data-dx="1" data-dy="0">‚Üí</div>
        <div></div> <div class="btn" data-dx="0" data-dy="1">‚Üì</div> <div></div>
      </div>
    </div>

    <!-- Panneau √©diteur -->
    <div id="editorPanel" class="editorPanel">
      <div class="title">√âdition des points</div>
      <div class="row"><b id="poiName"></b></div>
      <div class="row">Coordonn√©es : <span id="poiCoord"></span></div>
      <div class="row">
        <button id="prevPoi">‚óÄÔ∏é Pr√©c√©dent</button>
        <button id="nextPoi">Suivant ‚ñ∂Ô∏é</button>
      </div>
      <div class="row">
        <button id="copyPoi">Copier JSON</button>
        <button id="resetPoi">R√©initialiser</button>
        <button id="closeEditor">Fermer</button>
      </div>
      <p style="font-size:12px;margin:6px 0 0">Astuce : tape sur la carte pour placer le point s√©lectionn√©. Sauvegarde auto.</p>
    </div>
  </div>
</div>
<div id="debugBox"></div>

<script>
/* ---------- Boot bouton D√©marrer ---------- */
window.startGame = function(){
  try{
    var ov=document.getElementById('overlay'); if(ov) ov.style.display='none';
    var tch=document.getElementById('touch'); if(tch) tch.classList.add('show');
    var m=document.getElementById('musicBtn'); if(m) m.style.display='inline-block';
    var e=document.getElementById('editorBtn'); if(e) e.style.display='inline-block';
    if (typeof startMusic==='function') startMusic();
    if (typeof resize==='function') resize();
    window.running=true;
    if (typeof loop==='function') requestAnimationFrame(loop);
  }catch(err){ alert('Erreur au d√©marrage: '+err.message); }
};

/* ---------- Debug √©cran ---------- */
function debug(msg){const box=document.getElementById('debugBox');box.style.display='block';box.innerHTML+=(box.innerHTML?'<br>':'')+'‚ö†Ô∏è '+msg;}
window.addEventListener('error',e=>debug(e.message));
window.addEventListener('unhandledrejection',e=>debug((e.reason&&e.reason.message)||String(e.reason)));

/* ================== ASSETS ================== */
const MAP_URL="assets/salento-map.jpeg";
const BIRD_URL="assets/aracne .PNG";
const TARANTULA_URL="assets/tarantula .PNG";

/* ================== CANVAS ================== */
const canvas=document.getElementById('c'); const ctx=canvas.getContext('2d');
let W=0,H=0,dpr=1;
function resize(){ dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  W=canvas.clientWidth=canvas.parentElement.clientWidth;
  H=canvas.clientHeight=canvas.parentElement.clientHeight;
  canvas.width=W*dpr; canvas.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
}
resize(); addEventListener('resize', resize);

/* ================== UI REFS ================== */
const touch=document.getElementById('touch');
const scoreEl=document.getElementById('score');
const starsEl=document.getElementById('stars');
const tarBox=document.getElementById('tarBox');
const tarAvatar=document.getElementById('tarAvatar');
const bdTitle=document.getElementById('bdTitle');
const bdText=document.getElementById('bdText');
const errBox=document.getElementById('err');
const errText=document.getElementById('errText');
const musicBtn=document.getElementById('musicBtn');
const editorBtn=document.getElementById('editorBtn');
const editorPanel=document.getElementById('editorPanel');
const poiNameEl=document.getElementById('poiName');
const poiCoordEl=document.getElementById('poiCoord');
const prevPoi=document.getElementById('prevPoi');
const nextPoi=document.getElementById('nextPoi');
const copyPoi=document.getElementById('copyPoi');
const resetPoi=document.getElementById('resetPoi');
const closeEditor=document.getElementById('closeEditor');
tarAvatar.src=TARANTULA_URL;

/* ================== IMAGES ================== */
const mapImg=new Image(), birdImg=new Image(), spiderImg=new Image();
mapImg.onload=()=>{ drawSplash(); };
mapImg.onerror=()=>assetFail('Carte', MAP_URL, true);
birdImg.onerror=()=>assetFail('Aracne', BIRD_URL);
spiderImg.onerror=()=>assetFail('Tarantula', TARANTULA_URL);
mapImg.src=MAP_URL; birdImg.src=BIRD_URL; spiderImg.src=TARANTULA_URL;
function assetFail(who,url,showPlaceholder){
  errBox.style.display='block';
  errText.innerHTML += (errText.innerHTML? "<br>":"") + `‚Ä¢ ${who} introuvable : "${url}"`;
  if(showPlaceholder) drawSplash(true);
}

/* ============== DONN√âES CHASSE ============== */
/* Valeurs par d√©faut = TON JSON (d√©finitif) */
const DEFAULT_POIS = [
  { key:"otranto",      name:"Otranto ‚Äî Cath√©drale",         x:0.9776, y:0.4650, info:"Mosa√Øque m√©di√©vale (Arbre de Vie) & chapelle des 800 martyrs." },
  { key:"portobadisco", name:"Porto Badisco ‚Äî Calanque",     x:1.0000, y:0.4550, info:"Grande calanque turquoise entour√©e de falaises." },
  { key:"santacesarea", name:"Santa Cesarea Terme",          x:0.7800, y:0.6000, info:"Thermes soufr√©s & Villa Sticchi." },
  { key:"castro",       name:"Castro ‚Äî Castrum Minervae",    x:0.8843, y:0.6542, info:"Temple d‚ÄôAth√©na (l√©gende), grotte Zinzulusa." },
  { key:"ciolo",        name:"Il Ciolo",                     x:0.8475, y:0.7143, info:"Petit fjord + pont routier." },
  { key:"leuca",        name:"Santa Maria di Leuca",         x:0.8193, y:0.9275, info:"Phare haut & cascade monumentale." },
  { key:"gallipoli",    name:"Gallipoli",                    x:0.2514, y:0.6335, info:"Vieille ville sur √Ælot reli√© par pont." },
  { key:"portocesareo", name:"Porto Cesareo",                x:0.2200, y:0.4600, info:"Plages magnifiques & r√©serve marine." },
  { key:"nardo",        name:"Nard√≤",                        x:0.3431, y:0.4800, info:"Centre baroque ; Porto Selvaggio." },
  { key:"lecce",        name:"Lecce",                        x:0.5300, y:0.2800, info:"Baroque en pietra leccese." }
];

/* Copie active + chargement localStorage si pr√©sent */
let POIS = DEFAULT_POIS.map(p=>({ ...p }));
try{
  const saved = JSON.parse(localStorage.getItem('salento_pois')||'null');
  if(Array.isArray(saved) && saved.length===DEFAULT_POIS.length){
    for(let i=0;i<POIS.length;i++){
      if(saved[i] && typeof saved[i].x==='number' && typeof saved[i].y==='number'){
        POIS[i].x = saved[i].x; 
        POIS[i].y = saved[i].y;
      }
    }
  }
}catch(_){}

function savePOIsToStorage(){
  try{
    localStorage.setItem('salento_pois',
      JSON.stringify(POIS.map(({key,name,x,y})=>({key,name,x,y})))
    );
  }catch(_){}
}
function resetPOIs(){
  localStorage.removeItem('salento_pois');
  for(let i=0;i<POIS.length;i++){
    POIS[i].x = DEFAULT_POIS[i].x;
    POIS[i].y = DEFAULT_POIS[i].y;
  }
  updateEditorUI && updateEditorUI();
}

const player={ x:0.55, y:0.25, speed:0.0048, size:0.11 };
const collected=new Set();
let currentIdx=0;

/* ====== CHEMIN ANIM√â ====== */
let dashOffset=0, lastTS=0, frameDT=0;
const PATH={ dash:[10,6], speed:120, color:'#7a4c25', width:3, cap:'round', join:'round' };

/* ====== LABELS ====== */
const labels=[]; // {text,x,y,ttl}
function spawnLabel(text,x,y){ labels.push({text,x,y,ttl:1800}); }
function updateLabels(dt){ for(const L of labels){ L.ttl -= dt*1000; L.y -= 12*dt; } for(let i=labels.length-1;i>=0;i--) if(labels[i].ttl<=0) labels.splice(i,1); }
function drawLabels(){
  ctx.save();
  for(const L of labels){
    const a=Math.max(0,Math.min(1,L.ttl/1800));
    ctx.globalAlpha=a; ctx.fillStyle="rgba(255,255,255,0.95)"; ctx.strokeStyle="rgba(0,0,0,0.25)"; ctx.lineWidth=2;
    ctx.font="14px system-ui, -apple-system, sans-serif"; ctx.textAlign="center";
    const pad=6, w=ctx.measureText(L.text).width+pad*2, h=22;
    roundRect(ctx, L.x - w/2, L.y - h, w, h, 8); ctx.fill(); ctx.stroke();
    ctx.fillStyle="#222"; ctx.globalAlpha=Math.min(1,a+0.2); ctx.fillText(L.text, L.x, L.y-6);
  }
  ctx.restore();
}

/* ====== FEUX D‚ÄôARTIFICE (canvas) ====== */
let fireworks=[]; let finaleMode=false, finaleTimer=0;
function launchFireworksBurst(cx,cy,parts=36){
  for(let i=0;i<parts;i++){
    const ang=(i/parts)*Math.PI*2, speed=80+Math.random()*120;
    fireworks.push({ x:cx,y:cy, vx:Math.cos(ang)*speed, vy:Math.sin(ang)*speed, life:1.2+Math.random()*0.6, age:0, color:`hsl(${Math.floor(Math.random()*360)},80%,60%)` });
  }
}
function updateFireworks(dt){
  const g=140;
  fireworks=fireworks.filter(p=>{ p.age+=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=g*dt*0.5; return p.age<p.life; });
}
function drawFireworks(){
  ctx.save(); for(const p of fireworks){ const a=1-(p.age/p.life); ctx.globalAlpha=Math.max(0,a); ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill(); } ctx.restore();
}
function triggerFinale(){
  finaleMode=true; finaleTimer=4.5;
  for(let i=0;i<5;i++){ setTimeout(()=>{ launchFireworksBurst((0.15+0.7*Math.random())*W, (0.15+0.5*Math.random())*(H-UI_BOTTOM), 42); }, i*500); }
  playFinale();
}

/* ====== HUD & BULLE ====== */
function starSVG(fill){ const f=fill||"#d26f45"; return "data:image/svg+xml;base64,"+btoa(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 5 L61 36 L94 36 L67 55 L77 88 L50 68 L23 88 L33 55 L6 36 L39 36 Z' fill='${f}' stroke='#8c3f28' stroke-width='4' stroke-linejoin='round'/></svg>`); }
function refreshStars(){ scoreEl.textContent=collected.size; starsEl.innerHTML=''; for(let i=0;i<10;i++){ const im=new Image(); im.className='star'; im.src=starSVG(i<collected.size?"#d26f45":"#f0c9a7"); starsEl.appendChild(im);} }
refreshStars();
function showTarantulaAt(p,screenX,screenY){
  bdTitle.textContent="Tarantula ‚Äî "+p.name.split(" ‚Äî ")[0]; bdText.textContent=p.info;
  tarBox.style.left=Math.min(screenX+12,window.innerWidth-270)+'px'; tarBox.style.top=Math.max(12,screenY-30)+'px';
  tarBox.classList.remove('hide'); tarBox.classList.add('show'); tarBox.style.display='flex';
  clearTimeout(showTarantulaAt._t); showTarantulaAt._t=setTimeout(()=>hideTarantula(),4200);
}
function hideTarantula(){ tarBox.classList.add('hide'); setTimeout(()=>{ tarBox.classList.remove('show'); tarBox.style.display='none'; },160); }
tarBox.addEventListener('click', hideTarantula);

/* ============= CONTR√îLES TACTILES ============= */
let editorMode=false, editIndex=0;
for(const el of document.querySelectorAll('.btn')){
  const dx=parseFloat(el.dataset.dx), dy=parseFloat(el.dataset.dy);
  let press=false,id=null;
  const step=()=>{ if(!press || editorMode) return;
    player.x=Math.max(0,Math.min(1,player.x+dx*player.speed));
    player.y=Math.max(0,Math.min(1,player.y+dy*player.speed));
    id=requestAnimationFrame(step);
  };
  el.addEventListener('touchstart',e=>{press=true;step();e.preventDefault();},{passive:false});
  el.addEventListener('touchend',()=>{press=false;cancelAnimationFrame(id);});
}
/* Drag direct de l‚Äôoiseau (d√©sactiv√© en mode √©diteur) */
let dragging=false;
canvas.addEventListener('touchstart',e=>{
  const t=e.touches[0];
  if(editorMode){ // placer le POI s√©lectionn√©
    const [nx,ny]=screenToNorm(t.clientX,t.clientY);
    const p=POIS[editIndex];
    p.x=Math.max(0,Math.min(1,nx)); p.y=Math.max(0,Math.min(1,ny));
    savePOIsToStorage();
    updateEditorUI();
    spawnLabel(p.name.split(" ‚Äî ")[0], normToScreenX(p.x), normToScreenY(p.y)-30);
    e.preventDefault(); return;
  }
  const bx=player.x*W, by=player.y*H;
  if(Math.hypot(t.clientX-bx,t.clientY-by)<Math.min(W,H)*player.size*0.6){ dragging=true; e.preventDefault(); }
},{passive:false});
canvas.addEventListener('touchmove',e=>{
  if(!dragging || editorMode) return; const t=e.touches[0];
  player.x=Math.max(0,Math.min(1,t.clientX/W)); player.y=Math.max(0,Math.min(1,t.clientY/H)); e.preventDefault();
},{passive:false});
canvas.addEventListener('touchend',()=>dragging=false);
document.addEventListener('touchmove',e=>{ if(e.target.closest('.btn')||e.target.closest('canvas')) e.preventDefault(); },{passive:false});

/* ======== MUSIQUE (boost + emphasis + finale, iPhone OK) ======== */
let audioCtx=null, masterGain=null, musicOn=false, loopTimer=null;
function createAudioOnce(){ if(audioCtx) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain(); masterGain.gain.value=0.50; masterGain.connect(audioCtx.destination);
  const buffer=audioCtx.createBuffer(1,1,22050); const src=audioCtx.createBufferSource(); src.buffer=buffer; src.connect(masterGain); src.start(0);
}
async function startMusic(){ try{ createAudioOnce(); if(audioCtx.state==='suspended') await audioCtx.resume(); ping(700,0.18); musicOn=true; musicBtn.textContent="‚èπÔ∏è Musique"; playPhrase(); }catch(e){ console.warn(e); } }
function stopMusic(){ musicOn=false; if(loopTimer){clearTimeout(loopTimer); loopTimer=null;} if(audioCtx&&audioCtx.state!=="closed"){ audioCtx.suspend(); } musicBtn.textContent="üéµ Musique"; }
function toggleMusic(){ musicOn?stopMusic():startMusic(); }
musicBtn.addEventListener('click', toggleMusic);
function ping(freq=440,amp=0.2){ if(!audioCtx||!masterGain) return; const t=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type='square'; o.frequency.value=freq; g.gain.setValueAtTime(amp,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.14); o.connect(g).connect(masterGain); o.start(t); o.stop(t+0.16);
}
function playPhrase(){ if(!musicOn||!audioCtx) return; const notes=[262,294,330,349,392,440,494,523]; let t=audioCtx.currentTime;
  notes.forEach(f=>{ scheduleSquare(f,t,0.26,0.28); t+=0.30; }); loopTimer=setTimeout(playPhrase,2800);
}
function scheduleSquare(freq,start,dur=0.25,amp=0.26){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.value=freq;
  g.gain.setValueAtTime(amp,start); g.gain.exponentialRampToValueAtTime(0.001,start+dur); o.connect(g).connect(masterGain); o.start(start); o.stop(start+dur);
}
function starEmphasis(){ if(!audioCtx||!masterGain) return; const base=audioCtx.currentTime; [784,880,988,1175].forEach((f,i)=>scheduleSquare(f, base+i*0.08,0.18,0.42)); }
function playFinale(){ if(!audioCtx||!masterGain) return; if(loopTimer){clearTimeout(loopTimer); loopTimer=null;} const t0=audioCtx.currentTime+0.05;
  [523,659,784,988,1175].forEach((f,i)=>scheduleSquare(f,t0+i*0.12,0.22,0.45)); [523,659,784].forEach(f=>scheduleSquare(f,t0+0.75,0.60,0.40));
}

/* ============ RENDU & BOUCLE ============ */
const UI_BOTTOM=180; // laisse la place au D-pad
let lastGeom={ox:0,oy:0,dw:W,dh:H}; // pour convertir √©cran <-> normalis√©

function drawStarfish(cx,cy,R){
  ctx.save(); ctx.shadowColor='rgba(0,0,0,.2)'; ctx.shadowBlur=6; ctx.shadowOffsetY=3;
  ctx.beginPath(); const pts=5,inner=R*0.45;
  for(let i=0;i<pts*2;i++){const ang=(Math.PI/pts)*i - Math.PI/2; const r=(i%2===0)?R:inner; const x=cx+Math.cos(ang)*r; const y=cy+Math.sin(ang)*r; if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);}
  ctx.closePath(); ctx.fillStyle='#d26f45'; ctx.strokeStyle='#8c3f28'; ctx.lineWidth=3; ctx.fill(); ctx.stroke(); ctx.restore();
}

window.running=false;
function draw(ts){
  if(ts){ if(!lastTS) lastTS=ts; frameDT=Math.min(0.05,(ts-lastTS)/1000); lastTS=ts; dashOffset+=PATH.speed*frameDT;
    updateLabels(frameDT); if(finaleMode){ updateFireworks(frameDT); finaleTimer-=frameDT; if(finaleTimer<=0) finaleMode=false; } }

  // Mise √† l‚Äô√©chelle avec espace en bas
  const mw=mapImg.naturalWidth||1920, mh=mapImg.naturalHeight||1080;
  const availW=W, availH=Math.max(200,H-UI_BOTTOM);
  const scale=Math.min(availW/mw, availH/mh), dw=mw*scale, dh=mh*scale;
  const ox=(W-dw)/2, oy=Math.max(0,(availH-dh)/2);
  lastGeom={ox,oy,dw,dh};

  ctx.clearRect(0,0,W,H);

  // Carte
  if(mapImg.complete&&mapImg.naturalWidth) ctx.drawImage(mapImg,ox,oy,dw,dh);
  else{ ctx.fillStyle="#d9e6f2"; ctx.fillRect(ox,oy,dw,dh); ctx.fillStyle="#445"; ctx.font="16px system-ui"; ctx.fillText("Carte non charg√©e : "+MAP_URL, ox+14, oy+24); }

  // Chemin plein (parcouru)
  ctx.save(); ctx.strokeStyle="#7a4c25"; ctx.lineWidth=4; ctx.lineCap="round"; ctx.lineJoin="round";
  ctx.beginPath();
  for(let i=0;i<Math.min(currentIdx,POIS.length-1);i++){
    const a=POIS[i], b=POIS[i+1];
    const ax=ox+a.x*dw, ay=oy+a.y*dh, bx=ox+b.x*dw, by=oy+b.y*dh;
    const mx=(ax+bx)/2, my=(ay+by)/2 + ((i%2?1:-1)*8);
    if(i===0) ctx.moveTo(ax,ay);
    ctx.quadraticCurveTo(mx,my,bx,by);
  }
  ctx.stroke(); ctx.restore();

  // Segment suivant anim√© (pointill√©)
  if(currentIdx<POIS.length-1){
    const a=POIS[currentIdx], b=POIS[currentIdx+1];
    const ax=ox+a.x*dw, ay=oy+a.y*dh, bx=ox+b.x*dw, by=oy+b.y*dh;
    const mx=(ax+bx)/2, my=(ay+by)/2 + ((currentIdx%2?1:-1)*8);
    ctx.save(); ctx.setLineDash(PATH.dash); ctx.lineDashOffset=-dashOffset; ctx.strokeStyle=PATH.color; ctx.lineWidth=PATH.width; ctx.lineCap=PATH.cap; ctx.lineJoin=PATH.join;
    ctx.beginPath(); ctx.moveTo(ax,ay); ctx.quadraticCurveTo(mx,my,bx,by); ctx.stroke(); ctx.restore();
  }

  // X + √©toile active
  for(let i=0;i<=currentIdx && i<POIS.length;i++){
    const p=POIS[i]; const x=ox+p.x*dw, y=oy+p.y*dh;
    ctx.save(); ctx.translate(x,y); ctx.rotate(0.2); ctx.strokeStyle='#b04123'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(-8,-8); ctx.lineTo(8,8); ctx.moveTo(-8,8); ctx.lineTo(8,-8); ctx.stroke(); ctx.restore();
  }
  if(currentIdx<POIS.length){
    const p=POIS[currentIdx]; const x=ox+p.x*dw, y=oy+p.y*dh;
    drawStarfish(x, y-26, Math.max(18,Math.min(26,Math.min(W,H)*0.03)));
  }

  // Aracne (hirondelle)
  const bw=Math.min(170,Math.max(90,dw*player.size)), bx=ox+player.x*dw, by=oy+player.y*dh;
  if(birdImg.complete&&birdImg.naturalWidth) ctx.drawImage(birdImg,bx-bw/2,by-bw/2,bw,bw);
  else{ ctx.fillStyle="#333"; ctx.beginPath(); ctx.arc(bx,by,bw*0.35,0,Math.PI*2); ctx.fill(); }

  // Collision ‚Üí collecte
  if(!editorMode && currentIdx<POIS.length){
    const p=POIS[currentIdx]; const px=ox+p.x*dw, py=oy+p.y*dh;
    if(Math.hypot(bx-px,by-py)<44){
      collected.add(p.key); refreshStars(); starEmphasis();
      showTarantulaAt(p, px, py); spawnLabel(p.name.split(" ‚Äî ")[0], px, py-38);
      currentIdx++;
      if(currentIdx===POIS.length){ triggerFinale(); setTimeout(()=>{ alert("üéâ Bravo ! 10/10 √©toiles collect√©es."); }, 400); }
    }
  }

  // Mode √©diteur : montre tous les points + cible sur le point s√©lectionn√©
  if(editorMode){
    ctx.save();
    ctx.fillStyle='rgba(210,111,69,0.9)';
    for(let i=0;i<POIS.length;i++){
      const p=POIS[i], x=ox+p.x*dw, y=oy+p.y*dh;
      ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill();
      if(i===editIndex){ ctx.strokeStyle='#00aaff'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.stroke(); }
    }
    const ep=POIS[editIndex]; const ex=ox+ep.x*dw, ey=oy+ep.y*dh;
    ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.setLineDash([4,6]); ctx.beginPath(); ctx.moveTo(ex-18,ey); ctx.lineTo(ex+18,ey); ctx.moveTo(ex,ey-18); ctx.lineTo(ex,ey+18); ctx.stroke();
    ctx.restore();
  }

  // Labels + Feux d‚Äôartifice
  drawLabels();
  if(finaleMode || fireworks.length>0){ drawFireworks(); }
}

function loop(ts){ if(!window.running) return; draw(ts); requestAnimationFrame(loop); }

/* ============== SPLASH ============== */
function drawSplash(force){
  resize();
  if(mapImg.complete&&mapImg.naturalWidth){
    const mw=mapImg.naturalWidth, mh=mapImg.naturalHeight;
    const availW=W, availH=Math.max(200,H-UI_BOTTOM);
    const scale=Math.min(availW/mw, availH/mh), dw=mw*scale, dh=mh*scale;
    const ox=(W-dw)/2, oy=Math.max(0,(availH-dh)/2);
    ctx.drawImage(mapImg,ox,oy,dw,dh);
  } else if (force){
    ctx.fillStyle="#d9e6f2"; ctx.fillRect(0,0,W,H);
    ctx.fillStyle="#445"; ctx.font="16px system-ui"; ctx.fillText("Carte non charg√©e : "+MAP_URL, 14, 28);
  }
}

/* ====== Editor UI ====== */
function updateEditorUI(){
  const p=POIS[editIndex];
  poiNameEl.textContent=`${editIndex+1}/10 ${p.name}`;
  poiCoordEl.textContent=`x:${p.x.toFixed(4)}  y:${p.y.toFixed(4)}`;
}
editorBtn.addEventListener('click', ()=>{
  editorMode=!editorMode;
  editorPanel.style.display=editorMode?'block':'none';
  touch.classList.toggle('show', !editorMode); // cache D-pad en √©dition
  updateEditorUI();
});
closeEditor.addEventListener('click', ()=>{ editorMode=false; editorPanel.style.display='none'; touch.classList.add('show'); });
prevPoi.addEventListener('click', ()=>{ editIndex=(editIndex+POIS.length-1)%POIS.length; updateEditorUI(); });
nextPoi.addEventListener('click', ()=>{ editIndex=(editIndex+1)%POIS.length; updateEditorUI(); });
resetPoi.addEventListener('click', resetPOIs);
copyPoi.addEventListener('click', ()=>{
  const json=JSON.stringify(POIS.map(({key,name,x,y})=>({key,name,x:+x.toFixed(4),y:+y.toFixed(4)})),null,2);
  (navigator.clipboard&&navigator.clipboard.writeText)? navigator.clipboard.writeText(json).then(()=>alert('Copi√© !')).catch(()=>{ prompt('Copie manuelle :', json); })
  : prompt('Copie manuelle :', json);
});

/* ===== Helpers √©cran <-> normalis√© ===== */
let lastGeom={ox:0,oy:0,dw:W,dh:H};
function screenToNorm(sx,sy){ return [ (sx-lastGeom.ox)/lastGeom.dw, (sy-lastGeom.oy)/lastGeom.dh ]; }
function normToScreenX(nx){ return lastGeom.ox + nx*lastGeom.dw; }
function normToScreenY(ny){ return lastGeom.oy + ny*lastGeom.dh; }

/* ===== util: roundRect (Safari) ===== */
function roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath();
  ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,  x+w,y+h, rr); ctx.arcTo(x+w,y+h,x,  y+h, rr);
  ctx.arcTo(x,  y+h,x,  y,   rr); ctx.arcTo(x,  y,  x+w,y,   rr); ctx.closePath(); return ctx;
}
</script>
</body>
</html>
