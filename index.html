<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Salento ‚Äî Aracne & Tarantula (Chasse au tr√©sor)</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<style>
  /* ===== Base layout ===== */
  html,body{height:100%;margin:0;background:#f6f1e1;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{-webkit-tap-highlight-color:transparent}
  .wrap{display:flex;flex-direction:column;height:100%}
  .game{position:relative;flex:1;overflow:hidden}
  canvas{width:100%;height:100%;display:block;background:#e2eef7;touch-action:none}

  /* ===== Overlay titre ===== */
  .overlay{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(246,241,225,.84);backdrop-filter:blur(3px);z-index:20
  }
  .card{
    width:min(560px,92vw);border:2px solid #c8b37a;border-radius:14px;background:#fffdf5;
    box-shadow:0 10px 26px rgba(0,0,0,.18);padding:18px;text-align:center
  }
  .card h1{margin:0 0 6px 0;font-size:22px}
  .card p{margin:6px 0 14px 0;opacity:.82}
  .card button{border:1px solid #c8b37a;background:#ffe8a6;border-radius:10px;padding:12px 16px;font-weight:700}

  /* ===== HUD score ===== */
  .hud{
    position:absolute;left:10px;top:10px;background:rgba(255,248,220,.96);
    border:2px solid #c8b37a;border-radius:10px;padding:8px 10px;font-size:14px;z-index:10
  }
  .stars{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
  .star{width:18px;height:18px;opacity:.95}

  /* ===== Bulle Tarantula (corrig√©e : avatar sans fond + bulle neutre) ===== */
  .tarBox{position:absolute;display:none;align-items:flex-start;gap:8px;z-index:12;
          transform-origin:left bottom;transition:transform .15s ease,opacity .15s ease}
  .tarBox.show{display:flex;opacity:1;transform:scale(1)}
  .tarBox.hide{opacity:0;transform:scale(.95)}

  /* AVATAR TARANTULA SANS FOND/BORDURE */
  .tarBox img{
    width:64px;height:64px;object-fit:contain;
    background:transparent !important;border:none !important;border-radius:0 !important;box-shadow:none !important;
  }

  /* BULLE NEUTRE */
  .bdBubble{
    max-width:min(320px,56vw);background:#fff;border:1px solid #bbb;border-radius:14px;
    padding:10px 12px;box-shadow:0 4px 10px rgba(0,0,0,.12);position:relative;font-size:14px;line-height:1.25
  }
  .bdBubble:after{
    content:"";position:absolute;left:-10px;bottom:10px;border-width:10px;border-style:solid;border-color:transparent #bbb transparent transparent
  }
  .bdBubble:before{
    content:"";position:absolute;left:-9px;bottom:11px;border-width:9px;border-style:solid;border-color:transparent #fff transparent transparent
  }
  .bdTitle{font-weight:700;margin-bottom:4px}

  /* ===== D-pad tactile ===== */
  .touch{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:none;gap:14px;align-items:center;z-index:11}
  .touch.show{display:flex}
  .dpad{display:grid;grid-template-columns:72px 72px 72px;grid-template-rows:72px 72px 72px;gap:12px}
  .btn{width:72px;height:72px;border-radius:14px;border:2px solid #c8b37a;background:#fff7de;
       display:flex;align-items:center;justify-content:center;user-select:none;touch-action:none;font-weight:800;font-size:22px;box-shadow:0 3px 0 #c8b37a}
  .btn:active{transform:translateY(1px)}

  /* ===== Bouton musique ===== */
  #musicBtn{
    position:absolute;top:10px;right:10px;z-index:15;
    background:#ffe8a6;border:2px solid #c8b37a;border-radius:10px;padding:8px 12px;font-weight:700;
  }

  /* ===== Bandeau d‚Äôerreur assets ===== */
  .err{position:absolute;right:10px;top:10px;background:#ffefef;border:2px solid #d66;border-radius:10px;padding:8px 10px;font-size:12px;color:#900;z-index:30;max-width:min(320px,60vw)}
  .err b{display:block;margin-bottom:4px}
</style>
</head>
<body>
<div class="wrap">
  <div class="game">
    <!-- Overlay -->
    <div class="overlay" id="overlay">
      <div class="card">
        <h1>Salento ‚Äî Aracne & Tarantula</h1>
        <p>V√©ritable chasse au tr√©sor : une √©toile √† la fois. Suis la piste !</p>
        <button id="startBtn">D√©marrer</button>
      </div>
    </div>

    <button id="musicBtn" style="display:none">üéµ Musique</button>

    <div class="err" id="err" style="display:none">
      <b>‚ö†Ô∏è Probl√®me d‚Äôassets</b>
      <div id="errText"></div>
    </div>

    <canvas id="c"></canvas>

    <div class="hud">
      <div>√âtoiles : <span id="score">0</span>/10</div>
      <div class="stars" id="stars"></div>
    </div>

    <div class="tarBox" id="tarBox">
      <img id="tarAvatar" alt="Tarantula">
      <div class="bdBubble">
        <div class="bdTitle" id="bdTitle">Tarantula</div>
        <div id="bdText"></div>
      </div>
    </div>

    <div class="touch" id="touch">
      <div class="dpad">
        <div></div> <div class="btn" data-dx="0" data-dy="-1">‚Üë</div> <div></div>
        <div class="btn" data-dx="-1" data-dy="0">‚Üê</div> <div></div> <div class="btn" data-dx="1" data-dy="0">‚Üí</div>
        <div></div> <div class="btn" data-dx="0" data-dy="1">‚Üì</div> <div></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= 1) ASSETS ================= */
const MAP_URL      = "assets/salento-map.jpg";  // Carte
const BIRD_URL     = "assets/aracne .png";       // Aracne (hirondelle)
const TARANTULA_URL= "assets/tarantula .png";    // Tarantula (araign√©e)

/* ================= 2) Canvas ================= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W=0,H=0,dpr=1;
function resize(){
  dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  W=canvas.clientWidth=canvas.parentElement.clientWidth;
  H=canvas.clientHeight=canvas.parentElement.clientHeight;
  canvas.width=W*dpr; canvas.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', resize);

/* ================= 3) UI refs ================= */
const overlay=document.getElementById('overlay');
const startBtn=document.getElementById('startBtn');
const touch=document.getElementById('touch');
const scoreEl=document.getElementById('score'), starsEl=document.getElementById('stars');
const tarBox=document.getElementById('tarBox'), tarAvatar=document.getElementById('tarAvatar'), bdTitle=document.getElementById('bdTitle'), bdText=document.getElementById('bdText');
const errBox=document.getElementById('err'), errText=document.getElementById('errText');
const musicBtn=document.getElementById('musicBtn');
tarAvatar.src=TARANTULA_URL;

/* ================= 4) Images (pr√©chargement + diagnostics) ================= */
const mapImg=new Image(), birdImg=new Image(), spiderImg=new Image();
mapImg.onload=()=>{ drawSplash(); };
mapImg.onerror=()=>assetFail('Carte', MAP_URL, true);
birdImg.onerror=()=>assetFail('Aracne', BIRD_URL);
spiderImg.onerror=()=>assetFail('Tarantula', TARANTULA_URL);
mapImg.src=MAP_URL; birdImg.src=BIRD_URL; spiderImg.src=TARANTULA_URL;

function assetFail(who,url,showPlaceholder){
  errBox.style.display='block';
  const line=`‚Ä¢ ${who} introuvable : "${url}"`;
  errText.innerHTML = (errText.innerHTML? errText.innerHTML+"<br>":"")+line;
  if(showPlaceholder) drawSplash(true);
}

/* ================= 5) Donn√©es chasse ================= */
const POIS = [
  { key:"otranto",       name:"Otranto ‚Äî Cath√©drale",          x:0.86,y:0.52,info:"Mosa√Øque m√©di√©vale (Arbre de Vie) & chapelle des 800 martyrs (1480)." },
  { key:"portobadisco",  name:"Porto Badisco ‚Äî Calanque",      x:0.80,y:0.56,info:"Grande calanque turquoise, entour√©e de falaises." },
  { key:"santacesarea",  name:"Santa Cesarea Terme",           x:0.74,y:0.60,info:"Thermes soufr√©s & architecture √©clectique (Villa Sticchi)." },
  { key:"castro",        name:"Castro ‚Äî Castrum Minervae",     x:0.70,y:0.65,info:"Temple d‚ÄôAth√©na (l√©gende), grotte Zinzulusa, √©pisode d‚Äô√ân√©e." },
  { key:"ciolo",         name:"Il Ciolo",                      x:0.64,y:0.75,info:"Petit fjord avec pont routier au-dessus de l‚Äôeau profonde." },
  { key:"leuca",         name:"Santa Maria di Leuca",          x:0.60,y:0.88,info:"Phare haut & cascade monumentale au ‚Äòfinibus terrae‚Äô." },
  { key:"gallipoli",     name:"Gallipoli",                     x:0.35,y:0.62,info:"Vieille ville sur √Ælot reli√© par pont ; Kallipolis." },
  { key:"portocesareo",  name:"Porto Cesareo",                 x:0.22,y:0.46,info:"Plages magnifiques & r√©serve marine." },
  { key:"nardo",         name:"Nard√≤",                         x:0.28,y:0.50,info:"Centre baroque ; proximit√© de Porto Selvaggio." },
  { key:"lecce",         name:"Lecce",                         x:0.53,y:0.28,info:"Baroque en pietra leccese : Santa Croce, Duomo, amphith√©√¢tre." }
];

const player={ x:0.55, y:0.25, speed:0.0048, size:0.11 };   // positions normalis√©es [0..1]
const collected=new Set();
let currentIdx=0;  // √©tape active

/* Chemin anim√© (prochain segment seulement) */
let dashOffset=0, lastTS=0;
const PATH={ dash:[10,6], speed:120, color:'#7a4c25', width:3, cap:'round', join:'round' };

/* ================= 6) HUD & bulle ================= */
function starSVG(fill){ const f=fill||"#d26f45"; return "data:image/svg+xml;base64,"+btoa(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 5 L61 36 L94 36 L67 55 L77 88 L50 68 L23 88 L33 55 L6 36 L39 36 Z' fill='${f}' stroke='#8c3f28' stroke-width='4' stroke-linejoin='round'/></svg>`); }
function refreshStars(){ scoreEl.textContent=collected.size; starsEl.innerHTML=''; for(let i=0;i<10;i++){ const im=new Image(); im.className='star'; im.src=starSVG(i<collected.size?"#d26f45":"#f0c9a7"); starsEl.appendChild(im);} }
refreshStars();

function showTarantulaAt(p,screenX,screenY){
  bdTitle.textContent = "Tarantula ‚Äî " + p.name.split(" ‚Äî ")[0];
  bdText.textContent  = p.info;
  tarBox.style.left = Math.min(screenX + 12, window.innerWidth - 270) + 'px';
  tarBox.style.top  = Math.max(12, screenY - 30) + 'px';
  tarBox.classList.remove('hide'); tarBox.classList.add('show'); tarBox.style.display='flex';
  clearTimeout(showTarantulaAt._t); showTarantulaAt._t = setTimeout(()=>hideTarantula(), 4200);
}
function hideTarantula(){ tarBox.classList.add('hide'); setTimeout(()=>{ tarBox.classList.remove('show'); tarBox.style.display='none'; },160); }
tarBox.addEventListener('click', hideTarantula);

/* ================= 7) Contr√¥les ================= */
for(const el of document.querySelectorAll('.btn')){
  const dx=parseFloat(el.dataset.dx), dy=parseFloat(el.dataset.dy);
  let press=false,id=null;
  const step=()=>{ if(!press) return;
    player.x=Math.max(0,Math.min(1,player.x+dx*player.speed));
    player.y=Math.max(0,Math.min(1,player.y+dy*player.speed));
    id=requestAnimationFrame(step);
  };
  el.addEventListener('touchstart',e=>{press=true;step();e.preventDefault();},{passive:false});
  el.addEventListener('touchend',()=>{press=false;cancelAnimationFrame(id);});
}
/* Drag direct */
let dragging=false;
canvas.addEventListener('touchstart',e=>{
  const t=e.touches[0]; const bx=player.x*W, by=player.y*H;
  if(Math.hypot(t.clientX-bx,t.clientY-by)<Math.min(W,H)*player.size*0.6){dragging=true; e.preventDefault();}
},{passive:false});
canvas.addEventListener('touchmove',e=>{
  if(!dragging)return; const t=e.touches[0];
  player.x=Math.max(0,Math.min(1,t.clientX/W));
  player.y=Math.max(0,Math.min(1,t.clientY/H));
  e.preventDefault();
},{passive:false});
canvas.addEventListener('touchend',()=>dragging=false);
document.addEventListener('touchmove',e=>{
  if(e.target.closest('.btn')||e.target.closest('canvas')) e.preventDefault();
},{passive:false});

/* ================= 8) Musique r√©tro (Web Audio) ================= */
let audioCtx=null, musicOn=false, loopTimer=null;
function startMusic(){
  try{
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    else if(audioCtx.state==='suspended'){ audioCtx.resume(); }
    musicOn = true;
    musicBtn.textContent = "‚èπÔ∏è Musique";
    playPhrase();
  }catch(e){ console.warn('Audio init error', e); }
}
function stopMusic(){
  musicOn = false;
  if(loopTimer){ clearTimeout(loopTimer); loopTimer=null; }
  if(audioCtx && audioCtx.state!=="closed"){ audioCtx.suspend(); }
  musicBtn.textContent = "üéµ Musique";
}
function toggleMusic(){ (!musicOn)?startMusic():stopMusic(); }
function playPhrase(){
  if(!musicOn || !audioCtx) return;
  const notes=[262,294,330,349,392,440,494,523]; // do r√© mi fa sol la si do
  let t=audioCtx.currentTime;
  notes.forEach((freq,i)=>{
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.type="square";
    osc.frequency.value=freq;
    gain.gain.setValueAtTime(0.12,t);
    gain.gain.exponentialRampToValueAtTime(0.001,t+0.25);
    osc.connect(gain).connect(audioCtx.destination);
    osc.start(t);
    osc.stop(t+0.25);
    t+=0.3;
  });
  loopTimer=setTimeout(playPhrase, 2800);
}

/* ================= 9) Rendu & boucle ================= */
function drawStarfish(cx,cy,R){
  ctx.save(); ctx.shadowColor='rgba(0,0,0,.2)'; ctx.shadowBlur=6; ctx.shadowOffsetY=3;
  ctx.beginPath(); const pts=5,inner=R*0.45;
  for(let i=0;i<pts*2;i++){const ang=(Math.PI/pts)*i - Math.PI/2; const r=(i%2===0)?R:inner; const x=cx+Math.cos(ang)*r; const y=cy+Math.sin(ang)*r; if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);}
  ctx.closePath(); ctx.fillStyle='#d26f45'; ctx.strokeStyle='#8c3f28'; ctx.lineWidth=3; ctx.fill(); ctx.stroke(); ctx.restore();
}

let running=false;
function draw(ts){
  if(ts){ if(!lastTS) lastTS=ts; const dt=Math.min(0.05,(ts-lastTS)/1000); lastTS=ts; dashOffset+=PATH.speed*dt; }

  // Mise √† l‚Äô√©chelle ‚Äúletterbox‚Äù
  const mw=mapImg.naturalWidth||1920, mh=mapImg.naturalHeight||1080;
  const scale=Math.min(W/mw,H/mh), dw=mw*scale, dh=mh*scale, ox=(W-dw)/2, oy=(H-dh)/2;

  ctx.clearRect(0,0,W,H);

  // Carte
  if (mapImg.complete && mapImg.naturalWidth) ctx.drawImage(mapImg,ox,oy,dw,dh);
  else { ctx.fillStyle="#d9e6f2"; ctx.fillRect(ox,oy,dw,dh); ctx.fillStyle="#445"; ctx.font="16px system-ui"; ctx.fillText("Carte non charg√©e : "+MAP_URL, ox+14, oy+24); }

  // Segments d√©j√† parcourus (trait brun plein)
  ctx.save(); ctx.strokeStyle="#7a4c25"; ctx.lineWidth=4; ctx.lineCap="round"; ctx.lineJoin="round";
  ctx.beginPath();
  for(let i=0;i<Math.min(currentIdx,POIS.length-1);i++){
    const a=POIS[i], b=POIS[i+1];
    const ax=ox+a.x*dw, ay=oy+a.y*dh, bx=ox+b.x*dw, by=oy+b.y*dh;
    const mx=(ax+bx)/2, my=(ay+by)/2 + ((i%2?1:-1)*8); // l√©g√®re courbe
    if(i===0) ctx.moveTo(ax,ay);
    ctx.quadraticCurveTo(mx,my,bx,by);
  }
  ctx.stroke(); ctx.restore();

  // Prochain segment anim√© (pointill√©)
  if(currentIdx < POIS.length-1){
    const a=POIS[currentIdx], b=POIS[currentIdx+1];
    const ax=ox+a.x*dw, ay=oy+a.y*dh, bx=ox+b.x*dw, by=oy+b.y*dh;
    const mx=(ax+bx)/2, my=(ay+by)/2 + ((currentIdx%2?1:-1)*8);
    ctx.save();
    ctx.setLineDash(PATH.dash);
    ctx.lineDashOffset = -dashOffset;
    ctx.strokeStyle=PATH.color; ctx.lineWidth=PATH.width; ctx.lineCap=PATH.cap; ctx.lineJoin=PATH.join;
    ctx.beginPath(); ctx.moveTo(ax,ay); ctx.quadraticCurveTo(mx,my,bx,by); ctx.stroke();
    ctx.restore();
  }

  // X sur √©tapes visit√©es + √©toile visible pour l‚Äô√©tape active
  for(let i=0;i<=currentIdx && i<POIS.length;i++){
    const p=POIS[i]; const x=ox+p.x*dw, y=oy+p.y*dh;
    ctx.save(); ctx.translate(x,y); ctx.rotate(0.2); ctx.strokeStyle='#b04123'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(-8,-8); ctx.lineTo(8,8); ctx.moveTo(-8,8); ctx.lineTo(8,-8); ctx.stroke(); ctx.restore();
  }
  if(currentIdx < POIS.length){
    const p=POIS[currentIdx]; const x=ox+p.x*dw, y=oy+p.y*dh;
    drawStarfish(x, y-26, Math.max(18,Math.min(26,Math.min(W,H)*0.03)));
  }

  // Aracne (hirondelle)
  const bw=Math.min(170,Math.max(90,dw*player.size)), bx=ox+player.x*dw, by=oy+player.y*dh;
  if (birdImg.complete && birdImg.naturalWidth) ctx.drawImage(birdImg, bx-bw/2, by-bw/2, bw, bw);
  else { ctx.fillStyle="#333"; ctx.beginPath(); ctx.arc(bx,by,bw*0.35,0,Math.PI*2); ctx.fill(); }

  // Collision ‚Üí passe √† l‚Äô√©tape suivante + bulle
  if(currentIdx < POIS.length){
    const p=POIS[currentIdx]; const px=ox+p.x*dw, py=oy+p.y*dh;
    if(Math.hypot(bx-px,by-py)<44){
      collected.add(p.key); refreshStars();
      showTarantulaAt(p, px, py);
      currentIdx++;
      if(currentIdx===POIS.length){ setTimeout(()=>{ alert("üéâ Bravo ! 10/10 √©toiles collect√©es."); }, 350); }
    }
  }
}

function loop(ts){ if(!running) return; draw(ts); requestAnimationFrame(loop); }

/* ================= 10) D√©marrage ================= */
function drawSplash(force){
  resize();
  if (mapImg.complete && mapImg.naturalWidth){
    const mw=mapImg.naturalWidth, mh=mapImg.naturalHeight;
    const scale=Math.min(W/mw,H/mh), dw=mw*scale, dh=mh*scale, ox=(W-dw)/2, oy=(H-dh)/2;
    ctx.drawImage(mapImg,ox,oy,dw,dh);
  } else if (force){
    ctx.fillStyle="#d9e6f2"; ctx.fillRect(0,0,W,H);
    ctx.fillStyle="#445"; ctx.font="16px system-ui"; ctx.fillText("Carte non charg√©e : "+MAP_URL, 14, 28);
  }
}

startBtn.addEventListener('click', ()=>{
  overlay.style.display='none';
  touch.classList.add('show');
  musicBtn.style.display='inline-block'; // afficher le bouton musique
  startMusic(); // iOS: d√©clench√© par un geste utilisateur
  resize();
  running=true;
  requestAnimationFrame(loop);
});
startBtn.addEventListener('touchend', e=>{ e.preventDefault(); startBtn.click(); });
musicBtn.addEventListener('click', toggleMusic);

/* Emp√™che le scroll pendant le jeu sur iPhone */
document.addEventListener('touchmove', e => {
  if (e.target.closest('.btn') || e.target.closest('canvas')) e.preventDefault();
}, {passive:false});
</script>
</body>
</html>
